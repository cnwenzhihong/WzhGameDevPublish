<!doctype html>
<html
  lang="zh-cn" 
  data-theme-mode="false"
  >
  <head><script src="/WzhGameDevPublish/livereload.js?mindelay=10&amp;v=2&amp;port=6260&amp;path=WzhGameDevPublish/livereload" data-no-instant defer></script><meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/><title>
  FPS中的武器摇晃 | 温志洪
</title>
<meta name="description" content="FPS游戏"/><script>
  window.siteConfig = JSON.parse("{\"anchor_icon\":null,\"base\":\"http://localhost:6260/WzhGameDevPublish/\",\"clipboard\":{\"copyright\":{\"count\":50,\"enable\":false,\"license_type\":\"by-nc-sa\"},\"fail\":{\"en\":\"Copy failed (ﾟ⊿ﾟ)ﾂ\",\"ja\":\"コピー失敗 (ﾟ⊿ﾟ)ﾂ\",\"pt-br\":\"Falha ao copiar (ﾟ⊿ﾟ)ﾂ\",\"zh-cn\":\"复制失败 (ﾟ⊿ﾟ)ﾂ\",\"zh-tw\":\"複製失敗 (ﾟ⊿ﾟ)ﾂ\"},\"success\":{\"en\":\"Copy successfully (*^▽^*)\",\"ja\":\"コピー成功 (*^▽^*)\",\"pt-br\":\"Copiado com sucesso (*^▽^*)\",\"zh-cn\":\"复制成功 (*^▽^*)\",\"zh-tw\":\"複製成功 (*^▽^*)\"}},\"code_block\":{\"expand\":4},\"i18n_languages\":[{\"Lang\":\"en\",\"LanguageName\":\"English\",\"LanguageCode\":\"\",\"Title\":\"\",\"LanguageDirection\":\"\",\"Weight\":1,\"Disabled\":false},{\"Lang\":\"zh-cn\",\"LanguageName\":\"简体中文\",\"LanguageCode\":\"\",\"Title\":\"\",\"LanguageDirection\":\"\",\"Weight\":1,\"Disabled\":false}],\"icon_font\":\"4552607_4k4bc36ef96\",\"outdate\":{\"daysago\":180,\"enable\":false,\"message\":{\"en\":\"This article was last updated on {time}. Please note that the content may no longer be applicable.\",\"ja\":\"この記事は最終更新日：{time}。記載内容が現在有効でない可能性がありますのでご注意ください。\",\"pt-br\":\"Este artigo foi atualizado pela última vez em {time}. Observe que o conteúdo pode não ser mais aplicável.\",\"zh-cn\":\"本文最后更新于 {time}，请注意文中内容可能已不适用。\",\"zh-tw\":\"本文最後更新於 {time}，請注意文中內容可能已不適用。\"}}}");
  
</script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  rel="preload"
  as="style"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
/>
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
  media="print"
  onload="this.media='all'"
/>
<link
    rel="preload"
    href="//at.alicdn.com/t/c/font_4552607_4k4bc36ef96.woff2"
    as="font"
    type="font/woff2"
    crossorigin="anonymous"
  /><link rel="stylesheet" href="/WzhGameDevPublish/css/loader.css" />
<meta property="og:type" content="website" />
  <meta property="og:title" content="FPS中的武器摇晃 | 温志洪" />
  <meta
    property="og:description"
    content="FPS游戏"
  />
  <meta property="og:url" content="http://localhost:6260/WzhGameDevPublish/post/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6/lyra/fps/%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82/fps%E4%B8%AD%E7%9A%84%E6%AD%A6%E5%99%A8%E6%91%87%E6%99%83/" />
  <meta
    property="og:site_name"
    content="妖精游戏开发馆"
  />
  <meta
    property="og:image"
    content="/WzhGameDevPublish/"
  />
  <meta property="article:author" content="温志洪" />
  <meta property="article:published_time" content="2025-11-22T13:19:29&#43;00:00" />
  <meta property="article:modified_time" content="2025-12-24T12:38:47&#43;00:00" /><meta property="article:tag" content="3CFPSblog" /><meta name="twitter:card" content="summary" />
  <meta name="twitter:image" content="/WzhGameDevPublish/" />
<link rel="shortcut icon" href="/WzhGameDevPublish/favicon.ico"><link rel="stylesheet" href="/WzhGameDevPublish/css/main.css" />
<link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css"
    integrity="sha384-IfxC36XL/toUyJ939C73PcgMuRzAZuIzZxE38drsmO5p6jD7ei&#43;Zx/1oA/0l8ysE" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/katex@0.16.24/dist/katex.min.css"
    integrity="sha384-tTgKLjMYmJr94v8qu2PE5MUGSMbyN2xiH266JUB3gpm8vnnJywd1dWSOEfrFz&#43;YI" crossorigin="anonymous"onload="this.onload=null;this.rel='stylesheet'"
  /><script
    src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js"
    integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script><link
    rel="stylesheet"
    href="https://npm.webcache.cn/@reimujs/aos@0.1.2/dist/aos.css"
    integrity="sha384-GMRP93c6Hkz9JVKGAuRR3nTS7M07RwPgTFenXiosjq2VbVgvdDNcz1g6Mkj8AONa" crossorigin="anonymous"/></head>
  <body><div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi rotate"><svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
            <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="var(--red-1, #ff5252)" />
            <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
          M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="var(--red-1, #ff5252)" />
          </svg></div><div class="loading-word">少女祈祷中...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var loaderEl = document.getElementById('loader');
    var startLoading = () => {
      time = Date.now();
      loaderEl.classList.remove("loading");
    }
    var hideLoader = () => {
      document.body.style.overflow = 'auto';
      loader.classList.add('loading');
    };

    var endLoading = () => {
      if (!time) {
        hideLoader();
      } else {
        if (Date.now() - time > 500) {
          time = null;
          hideLoader();
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    loaderEl.addEventListener('click', endLoading);
  </script><div id="copy-tooltip"></div>
<div id="lang-tooltip">
本文章没有找到对应的语言版本
</div>
<div id="heatmap-tooltip"></div><div id="container">
      <div id="wrap"><div id="header-nav">
  <nav id="main-nav" aria-label="Primary navigation"><a class="main-nav-link-wrap" href="/WzhGameDevPublish/">
        <div class='main-nav-icon icon rotate'>&#xe62b;</div>
        <span class="main-nav-link">首页</span>
      </a><a class="main-nav-link-wrap" href="/WzhGameDevPublish/archives">
        <div class='main-nav-icon icon rotate'>&#xe62b;</div>
        <span class="main-nav-link">归档</span>
      </a><a class="main-nav-link-wrap" href="/WzhGameDevPublish/about">
        <div class='main-nav-icon icon rotate'>&#xe62b;</div>
        <span class="main-nav-link">关于</span>
      </a><a class="main-nav-link-wrap" href="/WzhGameDevPublish/friend">
        <div class='main-nav-icon icon rotate'>&#xe62b;</div>
        <span class="main-nav-link">友链</span>
      </a><a id="main-nav-toggle" class="nav-icon" aria-label="Toggle navigation" role="button"></a>
  </nav>
  <nav id="sub-nav" aria-label="Secondary navigation"></nav><nav id="i18n-nav" aria-label="Language selection">
      <div class="custom-dropdown">
        <div class="select-selected" id="select-selected" role="button" aria-haspopup="listbox" aria-expanded="false" aria-label="Language menu">
          <span id="nav-language-btn" class="nav-icon" style="padding: 0 20px 0 0"></span>
          <span id="selected-lang">简体中文</span>
        </div>
        <ul class="select-items" id="select-items" role="listbox" aria-label="Languages"><li data-value="en" role="option" arial-selected="false" >English</li><li data-value="zh-cn" role="option" class="selected" arial-selected="true" >简体中文</li></ul>
      </div>
      <script>
        var selectSelected = document.getElementById("select-selected");
        var selectedLang = document.getElementById("selected-lang");
        var selectItems = document.getElementById("select-items");
        var selectOptions = selectItems.querySelectorAll("li");

        selectSelected.addEventListener("click", () => {
          selectItems.classList.toggle("show");
          var expanded = selectSelected.getAttribute("aria-expanded") === "true";
          selectSelected.setAttribute("aria-expanded", (!expanded).toString());
        });

        selectOptions.forEach((item) => {
          item.addEventListener("click", () => {
            const langMap = {};selectedLang.textContent = item.textContent;
            selectItems.classList.remove("show");
            selectOptions.forEach((option) => {
              option.classList.remove("selected");
            });
            item.classList.add("selected");
            if (item.dataset.value === 'zh-cn') {
              return;
            }
            if (!langMap[item.dataset.value]) {
              _$("#lang-tooltip").style.opacity = "1";
              setTimeout(() => {
                _$("#lang-tooltip").style.opacity = "0";
              }, 1000);
              return;
            }
            window.location = langMap[item.dataset.value];
          });
        });

        document.addEventListener("click", (event) => {
          if (!event.target.closest(".custom-dropdown")) {
            selectItems.classList.remove("show");
            selectSelected.setAttribute("aria-expanded", "false");
          }
        });
      </script>
    </nav></div>
<header id="header" aria-label="Site header"><picture><source media="(max-width: 479px)" srcset="/WzhGameDevPublish/images/banner-600w.webp"><source media="(max-width: 799px)" srcset="/WzhGameDevPublish/images/banner-800w.webp"><source media="(min-width: 800px)" srcset="/WzhGameDevPublish/images/banner.webp"><img crossorigin="anonymous" fetchpriority="high" src="/WzhGameDevPublish/images/banner.webp" alt="FPS中的武器摇晃"></picture><img alt="FPS中的武器摇晃" style="visibility: hidden;"><div id="header-outer">
    <div id="header-title"><span id="logo">
            <h1 data-aos="slide-up">FPS中的武器摇晃</h1>
          </span><h2 id="subtitle-wrap" data-aos="slide-down"></h2></div>
  </div>
</header><div id="content"
          aria-label="Page content"
          
          class="sidebar-right"  ><aside id="sidebar" aria-label="Sidebar"><div class="sidebar-wrapper-container sticky"><div class="sidebar-wrapper">
    <div
      class="sidebar-wrap"
      data-aos="fade-up"
    ><div class="sidebar-toc-sidebar"><h3 class="toc-title">文章目录</h3>
<div class="sidebar-toc-wrapper toc-div-class">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#代码实现">代码实现</a>
      <ul>
        <li><a href="#一处理输入量">一、处理输入量</a></li>
        <li><a href="#二计算偏移量">二、计算偏移量</a></li>
        <li><a href="#三应用参数">三、应用参数</a></li>
      </ul>
    </li>
    <li><a href="#参数配置">参数配置</a>
      <ul>
        <li><a href="#优秀的实现案例">优秀的实现案例</a></li>
        <li><a href="#常见游戏方案">常见游戏方案</a></li>
        <li><a href="#工程化">工程化</a></li>
        <li><a href="#旋转ik_gun的yawpitch">旋转IK_Gun的Yaw/Pitch</a></li>
        <li><a href="#额外效果">额外效果</a></li>
      </ul>
    </li>
    <li><a href="#终极方案">终极方案</a>
      <ul>
        <li><a href="#代码">代码</a></li>
        <li><a href="#步骤">步骤</a></li>
      </ul>
    </li>
    <li><a href="#未处理的资料">未处理的资料</a>
      <ul>
        <li><a href="#gpt建议">GPT建议</a></li>
      </ul>
    </li>
    <li><a href="#被抛弃的方案">被抛弃的方案</a>
      <ul>
        <li><a href="#spring-arm">Spring Arm</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#基本概念">基本概念：</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div></div>
          <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img
    data-src="/WzhGameDevPublish/avatar/UELogo.png"
    data-sizes="auto"
    alt="温志洪"
    class="lazyload"
  />
  <div class="sidebar-author-name">温志洪</div>
  <div class="sidebar-description">FPS游戏</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>文章</div><div class="sidebar-state-number">2</div>
  </div>
  <a class="sidebar-state-category" href="/WzhGameDevPublish/categories/" aria-label="sidebar-state-category-link">
    <div>分类</div>
    <div class="sidebar-state-number">
      0
    </div>
  </a>
  <a class="sidebar-state-tag" href="/WzhGameDevPublish/tags/" aria-label="sidebar-state-tag-link">
    <div>标签</div>
    <div class="sidebar-state-number">3</div>
  </a>
</div>
<div class="sidebar-social"></div>
<div class="sidebar-menu"><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/WzhGameDevPublish/"
        aria-label="首页"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">首页</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/WzhGameDevPublish/archives"
        aria-label="归档"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">归档</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/WzhGameDevPublish/about"
        aria-label="关于"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">关于</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/WzhGameDevPublish/friend"
        aria-label="友链"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">友链</div>
    </div></div>
</div><div class="sidebar-btn-wrapper" style="position:static">
            <div class="sidebar-toc-btn current"></div>
            <div class="sidebar-common-btn"></div>
          </div></div>
  </div><div class="sidebar-widget"></div></div></aside>
<section id="main" aria-label="Main content"><article
  class="h-entry article"
  itemscope
  itemtype="https://schema.org/BlogPosting"
>
  <div
    class="article-inner"
    data-aos="fade-up"
  >
    <div class="article-meta"><div class="article-date">
  <span
    class="article-date-link icon-calendar"
    data-aos="zoom-in"
  >
    <time datetime="2025-11-22 13:19:29.88 &#43;0000 UTC" itemprop="datePublished"
      >2025-11-22</time
    >
    <time style="display: none;" id="post-update-time"
      >2025-12-24</time
    >
  </span><span
      class="article-date-link icon-calendar-plus"
      data-aos="zoom-in"
    >
      <time datetime="2025-12-24 12:38:47.548 &#43;0000 UTC" itemprop="dateModified"
        >2025-12-24</time
      >
    </span></div>
<div class="article-category"></div>
</div><div class="hr-line"></div><div class="e-content article-entry" itemprop="articleBody"><h1 id="旋转摇晃weapon-sway">
<a class="header-anchor" href="#%e6%97%8b%e8%bd%ac%e6%91%87%e6%99%83weapon-sway"></a>
旋转摇晃Weapon Sway
</h1><h2 id="代码实现">
<a class="header-anchor" href="#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0"></a>
代码实现
</h2><p>我们可以将其分为：获取转动输入→计算偏移量→表现三个步骤</p>
<blockquote>
<p>先获取用户转动差值，做各种处理后，用于表现效果</p>
</blockquote>
<h3 id="一处理输入量">
<a class="header-anchor" href="#%e4%b8%80%e5%a4%84%e7%90%86%e8%be%93%e5%85%a5%e9%87%8f"></a>
一、处理输入量
</h3><blockquote>
<p>计算转动量/输入量的速度，用于后续处理</p>
</blockquote>
<h4 id="11-原始数据采样转动量">
<a class="header-anchor" href="#11-%e5%8e%9f%e5%a7%8b%e6%95%b0%e6%8d%ae%e9%87%87%e6%a0%b7%e8%bd%ac%e5%8a%a8%e9%87%8f"></a>
1.1 原始数据采样——转动量
</h4><p>类似于TPS的瞄准偏移，但TPS关注角度，而FPS更在意变化量</p>
<h5 id="鼠标输入-">
<a class="header-anchor" href="#%e9%bc%a0%e6%a0%87%e8%be%93%e5%85%a5-"></a>
鼠标输入 ★★★
</h5><p>理论上是最直接简单的获取方式，完全不需要计算<br>
不容易获得精确数值(要么0要么1)。<br>
UE愈加复杂的输入系统让实现不再简单。</p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><p>0.1秒间隔，无太大必要优化，并未处于deltaSeconds<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/20251126063200443.png" alt=""></p></p>
  </blockquote>

<h5 id="旋转差值-">
<a class="header-anchor" href="#%e6%97%8b%e8%bd%ac%e5%b7%ae%e5%80%bc-"></a>
旋转差值 ★★★★★
</h5><p>计算<code>ControllerRotation</code>的旋转差值<br>
可以抹平不同鼠标Dpi的差距，获取差值也简单，需要单独保存上一帧的旋转量<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/20251216011431739.png" alt="|300"></p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FRotator</span> <span class="n">deltaRot</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">NormalizedDeltaRotator</span><span class="p">(</span><span class="n">CurrtRot</span><span class="p">,</span> <span class="n">ControlLastRot</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="n">ControlLastRot</span> <span class="o">=</span> <span class="n">CurrtRot</span><span class="p">;</span>  
</span></span></code></pre></div><blockquote>
<p>Rotator.Normalized:<br>
防止接近 ±180° 时出现跳变<br>
消除超过 ±360° 的累积角度<br>
Yaw Roll：[=180,180]<br>
Yaw：[-90,90]</p>
</blockquote></p>
  </blockquote>

<h4 id="12-计算二阶数据速度和加速度">
<a class="header-anchor" href="#12-%e8%ae%a1%e7%ae%97%e4%ba%8c%e9%98%b6%e6%95%b0%e6%8d%ae%e9%80%9f%e5%ba%a6%e5%92%8c%e5%8a%a0%e9%80%9f%e5%ba%a6"></a>
1.2 计算二阶数据——速度和加速度
</h4><h5 id="角速度">
<a class="header-anchor" href="#%e8%a7%92%e9%80%9f%e5%ba%a6"></a>
角速度
</h5><p>差值➗时间 即可得到角速度<br>
<code>s=d/t</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FVector2D</span> <span class="nf">rotSpeedFrame</span><span class="p">(</span><span class="n">deltaRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="n">deltaRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">);</span>
</span></span></code></pre></div><h5 id="加速度">
<a class="header-anchor" href="#%e5%8a%a0%e9%80%9f%e5%ba%a6"></a>
加速度
</h5><p><code>a=s/t</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FVector2D</span> <span class="nf">rotAccel</span><span class="p">((</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>
</span></span></code></pre></div><h4 id="13-输入数据处理">
<a class="header-anchor" href="#13-%e8%be%93%e5%85%a5%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86"></a>
1.3 输入数据处理
</h4><blockquote>
<p>主要对算出的Rot speed多次处理</p>
</blockquote>
<h5 id="低通滤波">
<a class="header-anchor" href="#%e4%bd%8e%e9%80%9a%e6%bb%a4%e6%b3%a2"></a>
低通滤波
</h5><blockquote>
<p>平滑变化速率较大的情况</p>
</blockquote>
<p>如果想平滑输入，可以对角速度进行低通滤波，会看起来更舒缓，但变化较慢。<br>
适用场景：</p>
<ul>
<li>大幅度摆动时，防止短时间参数跳变引起Target跳变</li>
<li>Interp平滑曲线，几乎必备</li>
</ul>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">bUseInputLowpass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">DeltaSeconds</span> <span class="o">*</span> <span class="mf">10.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="k">else</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="o">=</span><span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="o">=</span><span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></p>
  </blockquote>


  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><p>曲线对比：<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/20251215013753758.png" alt=""><br>
视觉效果：<br>
Normal:\ <video src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/NoLowpass.mp4" controls></video><br>
Lowpass\ <video src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/Lowpass.mp4" controls></video></p></p>
  </blockquote>

<h5 id="归一化">
<a class="header-anchor" href="#%e5%bd%92%e4%b8%80%e5%8c%96"></a>
归一化
</h5><blockquote>
<p>将数值映射到[-1,1]，方便后续操作</p>
</blockquote>
<p>角速度理论上可以无限大，需要限制最大值，顺带将其映射到[-1,1]，之后便不需要再考虑输入量的实际大小</p>
<h6 id="鼠标输入--1">
<a class="header-anchor" href="#%e9%bc%a0%e6%a0%87%e8%be%93%e5%85%a5--1"></a>
鼠标输入 ★
</h6><p>归一化受鼠标DPI影响，很难设定一个合理的数值范围，自定义程度弱(仅有最高和最低)，但不是不能做。</p>
<h6 id="旋转差值--1">
<a class="header-anchor" href="#%e6%97%8b%e8%bd%ac%e5%b7%ae%e5%80%bc--1"></a>
旋转差值 ★★★★★
</h6><p>可以规定每秒转动角度的最大值：如3600，在[-3600,+3600]内很容易控制表现效果。参考最大值：1440°/s</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//用一个“参考最大转速”fiducialRotSpeed 来归一化
</span></span></span><span class="line"><span class="cl"><span class="n">FVector2D</span> <span class="n">tmp_RotSpeed</span> <span class="o">=</span> <span class="n">originRotSpeed</span> <span class="o">/</span> <span class="n">fiducialRotSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">FVector2D</span> <span class="n">rotSpeedNormalize</span> <span class="o">=</span> <span class="n">FVector2D</span><span class="p">(</span><span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">tmp_RotSpeed</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">tmp_RotSpeed</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span></span></code></pre></div><h5 id="非线性映射">
<a class="header-anchor" href="#%e9%9d%9e%e7%ba%bf%e6%80%a7%e6%98%a0%e5%b0%84"></a>
非线性映射
</h5><p>小幅度转动时提供更小的视觉变化，大幅度转动时再提升效果往往能带来更好的效果。指数函数能较低成本地实现。<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/20251221161521741.png" alt=""></p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//可以改为曲线
</span></span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">NonLinear</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">float</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Sign</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Pow</span><span class="p">(</span><span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mf">1.15f</span><span class="p">);</span> <span class="p">};</span>  
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">NonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">NonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>
</span></span></code></pre></div></p>
  </blockquote>

<h3 id="二计算偏移量">
<a class="header-anchor" href="#%e4%ba%8c%e8%ae%a1%e7%ae%97%e5%81%8f%e7%a7%bb%e9%87%8f"></a>
二、计算偏移量
</h3><p>我们需要得到WeaponSway的关键结果：<code>SwayOffset</code>和<code>SwayRot</code></p>
<h4 id="21-计算sway-target">
<a class="header-anchor" href="#21-%e8%ae%a1%e7%ae%97sway-target"></a>
2.1 计算Sway Target
</h4><p>通过上面获取的输入量(偏移/速度/加速度)，处理得到想要的偏移和旋转目标值。</p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">swayOffsetTarget</span> <span class="o">=</span> <span class="n">FVector</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">    <span class="n">ControllerRotSpeed_Rate</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">ControllerRotSpeed_Rate</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">ControllerRotSpeed_Rate</span><span class="p">.</span><span class="n">Y</span> <span class="o">*</span> <span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Z</span>  
</span></span><span class="line"><span class="cl"><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="c1">//rotator构造函数顺序和蓝图显示顺序不一样，赋值能防止写参数时顺序混乱  
</span></span></span><span class="line"><span class="cl"><span class="n">swayRotTarget</span><span class="p">.</span><span class="n">Roll</span><span class="o">=</span><span class="n">ControllerRotSpeed_Rate</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Roll</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="n">swayRotTarget</span><span class="p">.</span><span class="n">Pitch</span><span class="o">=</span><span class="n">ControllerRotSpeed_Rate</span><span class="p">.</span><span class="n">Y</span> <span class="o">*</span> <span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="n">swayRotTarget</span><span class="p">.</span><span class="n">Yaw</span><span class="o">=</span><span class="n">ControllerRotSpeed_Rate</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Yaw</span><span class="p">;</span>
</span></span></code></pre></div></p>
  </blockquote>

<h5 id="左右旋转增加值">
<a class="header-anchor" href="#%e5%b7%a6%e5%8f%b3%e6%97%8b%e8%bd%ac%e5%a2%9e%e5%8a%a0%e5%80%bc"></a>
左右旋转增加值
</h5><blockquote>
<p>理论上我们应将左右、上下旋转做独立的Vector和Rotator映射，而不是直接指定轴。但偷了懒，且目前的参数够用</p>
</blockquote>
<p>上文代码中鼠标X移动控制Yaw和Roll旋转，但部分游戏中添加Pitch旋转能进一步增强效果，对其进行补充</p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UWeaponRotationSwayFragment</span><span class="o">::</span><span class="n">MouseXRotModify</span><span class="p">(</span><span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">swayRotTarget</span><span class="p">)</span> <span class="k">const</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">//Yaw叠加Roll  
</span></span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">pitchAdditionMulti</span><span class="o">=</span> <span class="n">ControllerRotSpeedNormalized</span><span class="p">.</span><span class="n">X</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">?</span> <span class="n">PitchAdditionMultiWithYaw</span><span class="p">.</span><span class="nl">X</span><span class="p">:</span><span class="n">PitchAdditionMultiWithYaw</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">pitch_Addition</span><span class="o">=</span><span class="n">ControllerRotSpeedNormalized</span><span class="p">.</span><span class="n">X</span>  <span class="o">*</span> <span class="n">pitchAdditionMulti</span> <span class="o">*</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Pow</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">abs</span><span class="p">(</span><span class="n">ControllerRotSpeedNormalized</span><span class="p">.</span><span class="n">Y</span><span class="p">),</span><span class="n">PitchAdditionPower</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">swayRotTarget</span><span class="p">.</span><span class="n">Pitch</span><span class="o">+=</span><span class="n">pitch_Addition</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></p>
  </blockquote>

<h4 id="22-对sway-target插值">
<a class="header-anchor" href="#22-%e5%af%b9sway-target%e6%8f%92%e5%80%bc"></a>
2.2 对Sway Target插值
</h4>
  <blockquote class="alert-blockquote important">
    <p class="alert-heading">
      Important
    </p>
    <p></p>
  </blockquote>

<h5 id="常用函数">
<a class="header-anchor" href="#%e5%b8%b8%e7%94%a8%e5%87%bd%e6%95%b0"></a>
常用函数
</h5><h6 id="interpto简单插值">
<a class="header-anchor" href="#interpto%e7%ae%80%e5%8d%95%e6%8f%92%e5%80%bc"></a>
InterpTo：简单插值
</h6><p>简单，效果也很不错，比较稳重，视觉变化小<br>
参数配置轻松</p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">SwayOffset</span><span class="o">!=</span><span class="n">swayOffsetTarget</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="n">SwayOffset</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">VInterpTo</span><span class="p">(</span> <span class="n">SwayOffset</span><span class="p">,</span><span class="n">swayOffsetTarget</span><span class="p">,</span><span class="n">DeltaSeconds</span><span class="p">,</span><span class="n">bHasInput</span><span class="o">?</span><span class="nl">InterpSpeed_Pos_Input</span><span class="p">:</span><span class="n">InterpSpeed_Pos_NoInput</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">SwayRot</span><span class="o">!=</span><span class="n">swayRotTarget</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">     <span class="n">SwayRot</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">RInterpTo</span><span class="p">(</span> <span class="n">SwayRot</span><span class="p">,</span><span class="n">swayRotTarget</span><span class="p">,</span><span class="n">DeltaSeconds</span><span class="p">,</span><span class="n">bHasInput</span><span class="o">?</span><span class="nl">InterpSpeed_Rot_Input</span><span class="p">:</span><span class="n">InterpSpeed_Rot_NoInput</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></p>
  </blockquote>

<h6 id="springinterpto模拟弹簧">
<a class="header-anchor" href="#springinterpto%e6%a8%a1%e6%8b%9f%e5%bc%b9%e7%b0%a7"></a>
SpringInterpTo：模拟弹簧
</h6><p>更灵动、反馈感更强，视觉变化快<br>
参数配置麻烦</p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">//position spring interp  
</span></span></span><span class="line"><span class="cl"><span class="n">SwayOffset</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">VectorSpringInterp</span><span class="p">(</span><span class="n">SwayOffset</span><span class="p">,</span> <span class="n">swayOffsetTarget</span><span class="p">,</span> <span class="n">PosSpringState</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                    <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Damping</span><span class="p">,</span> <span class="n">DeltaSeconds</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                    <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Mass</span><span class="p">,</span><span class="n">Params</span><span class="p">.</span><span class="n">TargetVelocityAmount</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// clamp  
</span></span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">SwayOffset</span><span class="p">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="n">SwayOffset</span> <span class="o">=</span> <span class="n">SwayOffset</span><span class="p">.</span><span class="n">GetSafeNormal</span><span class="p">()</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">//rotation spring interp  
</span></span></span><span class="line"><span class="cl"><span class="n">SwayRot</span> <span class="o">=</span> <span class="n">RotatorSpringInterp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">,</span> <span class="n">swayRotTarget</span><span class="p">,</span> <span class="n">RotSpringState</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Damping</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                              <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Mass</span><span class="p">,</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            
</span></span></code></pre></div><p>RotatorSpringInterp实现</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FRotator</span> <span class="n">UPawnComp_FPSRotWeaponSway</span><span class="o">::</span><span class="n">RotatorSpringInterp</span><span class="p">(</span><span class="k">const</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">Current</span><span class="p">,</span> <span class="k">const</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">Target</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                         <span class="n">FRotatorSpringState</span><span class="o">&amp;</span> <span class="n">State</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Stiffness</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Damping</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                         <span class="kt">float</span> <span class="n">DeltaTime</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Mass</span><span class="p">,</span><span class="n">FRotator</span> <span class="n">MaxRot</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="n">DeltaTime</span><span class="o">=</span><span class="n">DeltaTime</span><span class="o">&gt;</span><span class="n">RotMaxDeltaSeconds</span><span class="o">?</span><span class="nl">RotMaxDeltaSeconds</span><span class="p">:</span><span class="n">DeltaTime</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// Convert to vector for simple integration (Pitch, Yaw, Roll)  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="nf">cur</span><span class="p">(</span><span class="n">Current</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">Current</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">Current</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="nf">targ</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// Semi-implicit Euler integration  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">targ</span> <span class="o">-</span> <span class="n">cur</span><span class="p">)</span> <span class="o">*</span> <span class="n">Stiffness</span> <span class="o">-</span> <span class="n">State</span><span class="p">.</span><span class="n">Velocity</span> <span class="o">*</span> <span class="n">Damping</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">acc</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">/</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Max</span><span class="p">(</span><span class="n">Mass</span><span class="p">,</span> <span class="n">KINDA_SMALL_NUMBER</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">State</span><span class="p">.</span><span class="n">Velocity</span> <span class="o">+=</span> <span class="n">acc</span> <span class="o">*</span> <span class="n">DeltaTime</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">next</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">+</span> <span class="n">State</span><span class="p">.</span><span class="n">Velocity</span> <span class="o">*</span> <span class="n">DeltaTime</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">nextRot</span> <span class="o">=</span> <span class="n">FRotator</span><span class="p">(</span><span class="n">next</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">IsZero</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>       <span class="n">nextRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">nextRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="o">-</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">MaxRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nextRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">nextRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="o">-</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">MaxRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nextRot</span><span class="p">.</span><span class="n">Roll</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">nextRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">,</span> <span class="o">-</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">,</span> <span class="n">MaxRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>    <span class="k">return</span> <span class="n">nextRot</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>FRotatorSpringState</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">USTRUCT</span><span class="p">(</span><span class="n">BlueprintType</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">FRotatorSpringState</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="n">GENERATED_BODY</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">UPROPERTY</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">Velocity</span> <span class="o">=</span> <span class="n">FVector</span><span class="o">::</span><span class="n">ZeroVector</span><span class="p">;</span> <span class="c1">// pitch, yaw, roll velocity  
</span></span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div></p>
  </blockquote>


  <blockquote class="alert-blockquote note">
    <p class="alert-heading">
      Note
    </p>
    <p><p>可视化网站：<br>
target velocity amount: 到达目标的速度，0-1:紧贴目标<br>
stiffness: 越高越会跟上目标<br>
Critical Damping Factor:0-1 多有弹性，0:像橡皮筋<br>
k: stiffness 刚度值 控制加速度：越高加速越快，慢慢随距离衰减<br>
d: damping factor 阻尼 控制速度衰减(0-1)，越低越减速</p></p>
  </blockquote>


  <blockquote class="alert-blockquote note">
    <p class="alert-heading">
      Note
    </p>
    <p><p><a href="https://www.youtube.com/watch?v=8-jxARLG2Ik">参数介绍</a><br>
<a href="https://toqoz.fyi/springs.html?utm_source=chatgpt.com">Spring-based Animation and Quaternions</a><br>
<a href="https://www.reddit.com/r/gamedev/comments/31vwyg/game_math_precise_control_over_numeric_springing/?utm_source=chatgpt.com">优化实现：对数值弹簧的精确控制</a><br>
<a href="https://www.ryanjuckett.com/damped-springs/">Damped Springsa原理与实现</a><br>
<a href="https://zhuanlan.zhihu.com/p/412291354">UE4中的阻尼弹簧平滑</a></p></p>
  </blockquote>

<h3 id="三应用参数">
<a class="header-anchor" href="#%e4%b8%89%e5%ba%94%e7%94%a8%e5%8f%82%e6%95%b0"></a>
三、应用参数
</h3>
  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UPawnComp_FPSRotWeaponSway</span><span class="o">::</span><span class="n">TickWeaponSway</span><span class="p">(</span><span class="kt">float</span> <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="k">const</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">ControlRotation</span><span class="p">,</span> <span class="n">ESwayState</span> <span class="n">NewState</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">DeltaSeconds</span> <span class="o">&lt;=</span> <span class="mf">0.f</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">LocalTime</span> <span class="o">+=</span> <span class="n">DeltaSeconds</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// State transitions  
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">NewState</span> <span class="o">!=</span> <span class="n">CurrentState</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>       <span class="n">CurrentState</span> <span class="o">=</span> <span class="n">NewState</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">       <span class="n">StateStartTime</span> <span class="o">=</span> <span class="n">LocalTime</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">FSwayParams</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">Params</span> <span class="o">=</span> <span class="n">GetParamsForState</span><span class="p">(</span><span class="n">CurrentState</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) delta rot  
</span></span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">deltaRot</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">NormalizedDeltaRotator</span><span class="p">(</span><span class="n">ControlRotation</span><span class="p">,</span> <span class="n">LastControlRot</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">LastControlRot</span> <span class="o">=</span> <span class="n">ControlRotation</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) rot speed (deg/s) and smoothing  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="nf">rotSpeedFrame</span><span class="p">(</span><span class="n">deltaRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="n">deltaRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// low-pass smoothing  
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bUseInputLowpass</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>       <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">DeltaSeconds</span> <span class="o">*</span> <span class="mf">10.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>    <span class="k">else</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">       <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="o">=</span><span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">       <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="o">=</span><span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>    <span class="c1">// accel  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="nf">rotAccel</span><span class="p">((</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                       <span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) normalize  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="nf">rotSpeedNorm</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">/</span> <span class="n">Params</span><span class="p">.</span><span class="n">FiducialRotSpeed</span><span class="p">,</span> <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">/</span> <span class="n">Params</span><span class="p">.</span><span class="n">FiducialRotSpeed</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) nonlinear mapping (emphasize higher speeds)  
</span></span></span><span class="line"><span class="cl">    <span class="c1">//改为曲线，可以手动选择曲线  
</span></span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">NonLinear</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">float</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Sign</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Pow</span><span class="p">(</span><span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mf">1.15f</span><span class="p">);</span> <span class="p">};</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">NonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">NonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl"><span class="c1">// 5) compute translation target  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">swayOffsetTarget</span> <span class="o">=</span> <span class="n">FVector</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">       <span class="n">ny</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Z</span>  
</span></span><span class="line"><span class="cl">    <span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 6) compute rotation target (separate)  
</span></span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">swayRotTarget</span> <span class="o">=</span> <span class="n">FRotator</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">       <span class="n">ny</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Roll</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span>  
</span></span><span class="line"><span class="cl">    <span class="p">);</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 9) position spring interp    SwayOffset = UKismetMathLibrary::VectorSpringInterp(SwayOffset, swayOffsetTarget, PosSpringState,  
</span></span></span><span class="line"><span class="cl">                                                        <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Damping</span><span class="p">,</span> <span class="n">DeltaSeconds</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                        <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Mass</span><span class="p">,</span><span class="n">Params</span><span class="p">.</span><span class="n">TargetVelocityAmount</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// clamp  
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">SwayOffset</span><span class="p">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>       <span class="n">SwayOffset</span> <span class="o">=</span> <span class="n">SwayOffset</span><span class="p">.</span><span class="n">GetSafeNormal</span><span class="p">()</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// 10) rotation spring interp  
</span></span></span><span class="line"><span class="cl">    <span class="n">SwayRot</span> <span class="o">=</span> <span class="n">RotatorSpringInterp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">,</span> <span class="n">swayRotTarget</span><span class="p">,</span> <span class="n">RotSpringState</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Damping</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                  <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Mass</span><span class="p">,</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FRotator</span> <span class="n">UPawnComp_FPSRotWeaponSway</span><span class="o">::</span><span class="n">RotatorSpringInterp</span><span class="p">(</span><span class="k">const</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">Current</span><span class="p">,</span> <span class="k">const</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">Target</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                         <span class="n">FRotatorSpringState</span><span class="o">&amp;</span> <span class="n">State</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Stiffness</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Damping</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                         <span class="kt">float</span> <span class="n">DeltaTime</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Mass</span><span class="p">,</span><span class="n">FRotator</span> <span class="n">MaxRot</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="n">DeltaTime</span><span class="o">=</span><span class="n">DeltaTime</span><span class="o">&gt;</span><span class="n">RotMaxDeltaSeconds</span><span class="o">?</span><span class="nl">RotMaxDeltaSeconds</span><span class="p">:</span><span class="n">DeltaTime</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// Convert to vector for simple integration (Pitch, Yaw, Roll)  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="nf">cur</span><span class="p">(</span><span class="n">Current</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">Current</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">Current</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="nf">targ</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// Semi-implicit Euler integration  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">targ</span> <span class="o">-</span> <span class="n">cur</span><span class="p">)</span> <span class="o">*</span> <span class="n">Stiffness</span> <span class="o">-</span> <span class="n">State</span><span class="p">.</span><span class="n">Velocity</span> <span class="o">*</span> <span class="n">Damping</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">acc</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">/</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Max</span><span class="p">(</span><span class="n">Mass</span><span class="p">,</span> <span class="n">KINDA_SMALL_NUMBER</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">State</span><span class="p">.</span><span class="n">Velocity</span> <span class="o">+=</span> <span class="n">acc</span> <span class="o">*</span> <span class="n">DeltaTime</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">next</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">+</span> <span class="n">State</span><span class="p">.</span><span class="n">Velocity</span> <span class="o">*</span> <span class="n">DeltaTime</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">nextRot</span> <span class="o">=</span> <span class="n">FRotator</span><span class="p">(</span><span class="n">next</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">IsZero</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>       <span class="n">nextRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">nextRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="o">-</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">MaxRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nextRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">nextRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="o">-</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">MaxRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nextRot</span><span class="p">.</span><span class="n">Roll</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">nextRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">,</span> <span class="o">-</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">,</span> <span class="n">MaxRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>    <span class="k">return</span> <span class="n">nextRot</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></p>
  </blockquote>

<h4 id="基本使用">
<a class="header-anchor" href="#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8"></a>
基本使用
</h4><p>在Tick中使用<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/20251218041755810.png" alt=""></p>
<p>将计算出的参数用于修改武器IK骨骼即可<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/20251218035612026.png" alt=""></p>
<h4 id="拓展">
<a class="header-anchor" href="#%e6%8b%93%e5%b1%95"></a>
拓展
</h4><h5 id="改变旋转中心">
<a class="header-anchor" href="#%e6%94%b9%e5%8f%98%e6%97%8b%e8%bd%ac%e4%b8%ad%e5%bf%83"></a>
改变旋转中心
</h5><p>有的文章中提到，Yaw轴旋转可以设置为绕枪托旋转效果会更好<br>
下图以枪口为轴枢点更方便理解：<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/weaponsway_yawpivot.png" alt=""></p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 8) Yaw旋转优化  
</span></span></span><span class="line"><span class="cl"><span class="n">FVector</span> <span class="n">PivotLoc</span><span class="o">=</span><span class="n">FVector</span><span class="o">::</span><span class="n">ZeroVector</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// 8.1) 先尝试获取Socket，没有再获取Vector  
</span></span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Params</span><span class="p">.</span><span class="n">YawPivotSocket</span><span class="p">.</span><span class="n">IsNone</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">weaponMesh</span><span class="o">=</span> <span class="n">ULyraFPSFunctionLibrary</span><span class="o">::</span><span class="n">GetWeaponMesh</span><span class="p">(</span><span class="n">GetOwner</span><span class="p">()))</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>       <span class="n">PivotLoc</span><span class="o">=</span><span class="n">weaponMesh</span><span class="o">-&gt;</span><span class="n">GetSocketTransform</span><span class="p">(</span><span class="n">Params</span><span class="p">.</span><span class="n">YawPivotSocket</span><span class="p">,</span><span class="n">RTS_Component</span><span class="p">).</span><span class="n">GetLocation</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}}</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">PivotLoc</span><span class="o">==</span><span class="n">FVector</span><span class="o">::</span><span class="n">ZeroVector</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="n">PivotLoc</span><span class="o">=</span><span class="n">Params</span><span class="p">.</span><span class="n">YawPivotVector</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// 8.2) 正式处理  
</span></span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">PivotLoc</span><span class="o">!=</span><span class="n">FVector</span><span class="o">::</span><span class="n">ZeroVector</span><span class="o">&amp;&amp;!</span><span class="n">SwayRot</span><span class="p">.</span><span class="n">IsNearlyZero</span><span class="p">())</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">aroundLoc</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">aroundRot</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">UWeaponSwayFunctionlibrary</span><span class="o">::</span><span class="n">RotateAroundPivot</span><span class="p">(</span><span class="n">PivotLoc</span><span class="p">,</span><span class="n">FRotator</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SwayRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">,</span><span class="n">aroundLoc</span><span class="p">,</span><span class="n">aroundRot</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">SwayOffset</span><span class="p">.</span><span class="n">X</span><span class="o">=</span><span class="n">aroundLoc</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">SwayOffset</span><span class="p">.</span><span class="n">Y</span><span class="o">=</span><span class="n">aroundLoc</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">SwayRot</span><span class="p">.</span><span class="n">Yaw</span><span class="o">=</span><span class="n">aroundRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>绕某个 Pivot 点做旋转（任意旋转），返回变换后的位置与旋转</li>
<li>原理：T = Pivot + R * (Pos - Pivot)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UWeaponSwayFunctionlibrary</span><span class="o">::</span><span class="n">RotateAroundPivot</span><span class="p">(</span><span class="n">FVector</span> <span class="n">Pivot</span><span class="p">,</span> <span class="k">const</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">DeltaRot</span><span class="p">,</span> <span class="n">FVector</span><span class="o">&amp;</span> <span class="n">OutPosition</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">OutRotation</span><span class="p">,</span> <span class="k">const</span> <span class="n">FVector</span> <span class="n">InPosition</span><span class="p">,</span> <span class="k">const</span> <span class="n">FRotator</span> <span class="n">InRotation</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 1: 相对 Pivot 的偏移  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">RelPos</span> <span class="o">=</span> <span class="n">InPosition</span> <span class="o">-</span> <span class="n">Pivot</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 2: 构建旋转 Quat    FQuat QuatRot = DeltaRot.Quaternion();  
</span></span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 3: 应用旋转  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">RotatedRelPos</span> <span class="o">=</span> <span class="n">QuatRot</span> <span class="o">*</span> <span class="n">RelPos</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 4: 恢复到世界位置  
</span></span></span><span class="line"><span class="cl">    <span class="n">OutPosition</span> <span class="o">=</span> <span class="n">Pivot</span> <span class="o">+</span> <span class="n">RotatedRelPos</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 5: 应用旋转叠加  
</span></span></span><span class="line"><span class="cl">    <span class="n">OutRotation</span> <span class="o">=</span> <span class="p">(</span><span class="n">FRotationMatrix</span><span class="p">(</span><span class="n">InRotation</span><span class="p">).</span><span class="n">ToQuat</span><span class="p">()</span> <span class="o">*</span> <span class="n">QuatRot</span><span class="p">).</span><span class="n">Rotator</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></p>
  </blockquote>

<p>蓝图使用：<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/20251218042239133.png" alt=""></p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><p>枪托为中心(Pivot=(0,-5,0)) <video src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/2025-12-18%2005-16-05.mp4" controls></video><br>
枪头为中心(Pivot=(0,10,0))<video src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/2025-12-18%2005-19-39.mp4" controls></video></p></p>
  </blockquote>

<h2 id="参数配置">
<a class="header-anchor" href="#%e5%8f%82%e6%95%b0%e9%85%8d%e7%bd%ae"></a>
参数配置
</h2><h3 id="优秀的实现案例">
<a class="header-anchor" href="#%e4%bc%98%e7%a7%80%e7%9a%84%e5%ae%9e%e7%8e%b0%e6%a1%88%e4%be%8b"></a>
优秀的实现案例
</h3><p><a href="https://www.bilibili.com/video/BV14UfZYaEQn">【自制COD20 ?】开发日志5-绕任意轴旋转枪身</a>：左右旋转采用三轴共转能实现极为大开大合的效果</p>
<h4 id="31-变化速率">
<a class="header-anchor" href="#31-%e5%8f%98%e5%8c%96%e9%80%9f%e7%8e%87"></a>
3.1 变化速率
</h4><h5 id="平滑速率">
<a class="header-anchor" href="#%e5%b9%b3%e6%bb%91%e9%80%9f%e7%8e%87"></a>
平滑速率
</h5><p>一般游戏采用方案</p>
<h5 id="先慢后快">
<a class="header-anchor" href="#%e5%85%88%e6%85%a2%e5%90%8e%e5%bf%ab"></a>
先慢后快
</h5><p>需要又稳重又不让感觉拖沓的环境下(CS)，鼠标停下后立刻加快插值速度，营造确认感。</p>

  <blockquote class="alert-blockquote note">
    <p class="alert-heading">
      Note
    </p>
    <p><ul>
<li>CriticalDamping 通常设为 <code>2 * sqrt(Stiffness * Mass)</code> 才为临界阻尼，设置不同值，可得到欠阻尼（震荡）或过阻尼（缓慢）效果。建议理解该物理背景。</li>
<li>可以尝试的参数配置：Stiffness 中等偏高（快速响应但不过火）、CriticalDamping 多数接近 1（轻微震荡但不发狂）、Mass 视武器重量或状态而定（重武器 Mass大→摆动慢）。</li>
<li>大 Mass +大 Stiffness 可能导致高频震荡或振幅异常。</li>
<li>每帧确认 deltaSeconds 非常小的情况下数值稳定性，避免弹簧公式爆炸（如果 stiffness or mass 过大且 delta small）。可做最大 delta clamp。</li>
</ul></p>
  </blockquote>


  <blockquote class="alert-blockquote note">
    <p class="alert-heading">
      Note
    </p>
    <p><p>最好的效果：玩家向右转，武器向左并稍微上/下摆动、同时绕自身轻微旋转</p>
<ul>
<li>swayOffsetMulti用 <strong>速度曲线（非线性）</strong> 替代：比如用速度^n 或平滑函数（例如 SmoothStep）以便高转速带更强但低转速微弱。</li>
<li>为偏移和旋转分别设计 <strong>不同方向响应</strong>：例如 yaw→横向 + roll，pitch→纵向 + pitch 轻微。</li>
</ul></p>
  </blockquote>


  <blockquote class="alert-blockquote note">
    <p class="alert-heading">
      Note
    </p>
    <p><p><strong>fiducialRotSpeed 可以根据不同模式（走、跑、蹲、瞄准）动态改变</strong>。跑动时武器晃动更强，瞄准时更弱。</p></p>
  </blockquote>

<h3 id="常见游戏方案">
<a class="header-anchor" href="#%e5%b8%b8%e8%a7%81%e6%b8%b8%e6%88%8f%e6%96%b9%e6%a1%88"></a>
常见游戏方案
</h3><p>从大小来看有超前和追赶两种状态，前者看起来更灵敏，后者看起来更真实<br>
从移动方式来看，围绕角色旋转、围绕右手旋转、围绕右手偏移</p>
<h4 id="围绕角色旋转">
<a class="header-anchor" href="#%e5%9b%b4%e7%bb%95%e8%a7%92%e8%89%b2%e6%97%8b%e8%bd%ac"></a>
围绕角色旋转：
</h4><p>出现于很多老游戏中，如虚幻竞技场，一般用Lag就能实现<br>
容易实现，视野变化大，一般搭配角色追随摄像机效果，体现沉重感</p>
<h5 id="示例">
<a class="header-anchor" href="#%e7%a4%ba%e4%be%8b"></a>
示例
</h5>
  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><p>采用Lag，少量延迟，停下时立刻追赶上，给人感觉并不拖沓<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/RotSway_CS2.mp4" alt=""></p></p>
  </blockquote>


  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><p><a href="https://forums.unrealengine.com/t/weapon-sway-solved">https://forums.unrealengine.com/t/weapon-sway-solved</a><br>
<a href="https://www.youtube.com/watch?v=6OFmhQ55iJo">TFE Game - Rotation Lag/Leading</a><br>
我发现除了旋转滞后/领先之外，如果你同时根据滞后/领先值做一些相对位置偏移，效果会好很多。也就是说，我当前的 UpdateWeaponLoc 函数如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">APWNWeapon</span><span class="o">::</span><span class="n">UpdateLocRot</span><span class="p">(</span><span class="n">FVector</span> <span class="n">newLoc</span><span class="p">,</span> <span class="n">FRotator</span> <span class="n">newRot</span><span class="p">,</span> <span class="kt">float</span> <span class="n">deltaTime</span><span class="p">)</span> <span class="p">{</span> <span class="n">FRotator</span> <span class="n">finalRot</span> <span class="o">=</span> <span class="n">newRot</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">// Rotation Leading/Lag
</span></span></span><span class="line"><span class="cl">  <span class="kt">float</span> <span class="n">lagDiff</span><span class="p">;</span> <span class="n">finalRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">=</span> <span class="n">LagWeaponRotation</span><span class="p">(</span><span class="n">newRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">LastRotation</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">deltaTime</span><span class="p">,</span> <span class="n">MaxPitchLag</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lagDiff</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="n">finalRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">=</span> <span class="n">LagWeaponRotation</span><span class="p">(</span><span class="n">newRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">LastRotation</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">deltaTime</span><span class="p">,</span> <span class="n">MaxYawLag</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lagDiff</span><span class="p">);</span> <span class="n">finalRot</span><span class="p">.</span><span class="n">Roll</span> <span class="o">=</span> <span class="n">newRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">// Location offset 
</span></span></span><span class="line"><span class="cl">  <span class="kt">float</span> <span class="n">locDiff</span> <span class="o">=</span> <span class="n">lagDiff</span> <span class="o">/</span> <span class="n">MaxYawLag</span><span class="p">;</span> <span class="n">locDiff</span> <span class="o">*=</span> <span class="n">MaxLocLagX</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="n">ArmMesh</span><span class="o">-&gt;</span><span class="n">SetRelativeLocation</span><span class="p">(</span><span class="n">FVector</span><span class="p">(</span><span class="n">ArmMeshOffset</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">ArmMeshOffset</span><span class="p">.</span><span class="n">Y</span> <span class="o">+</span> <span class="n">locDiff</span><span class="p">,</span> <span class="n">ArmMeshOffset</span><span class="p">.</span><span class="n">Z</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">// Set our loc 
</span></span></span><span class="line"><span class="cl">  <span class="n">LastRotation</span> <span class="o">=</span> <span class="n">newRot</span><span class="p">;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">SetActorLocation</span><span class="p">(</span><span class="n">newLoc</span><span class="p">);</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">SetActorRotation</span><span class="p">(</span><span class="n">finalRot</span><span class="p">);</span> 
</span></span></code></pre></div></p>
  </blockquote>

<p><img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/TFE%20Game%20-%20Rotation%20Lag%E2%A7%B8Leading.mp4" alt=""></p>
<h4 id="围绕手武器旋转">
<a class="header-anchor" href="#%e5%9b%b4%e7%bb%95%e6%89%8b%e6%ad%a6%e5%99%a8%e6%97%8b%e8%bd%ac"></a>
围绕手/武器旋转
</h4><p>大量游戏和教程采用<br>
容易实现，视角变化适中，大都为超前效果，看起来相应很快，应用于双手步枪有非常好的效果。</p>
<h5 id="原则">
<a class="header-anchor" href="#%e5%8e%9f%e5%88%99"></a>
原则
</h5><p>一般左右旋转控制Yaw轴、上下旋转控制Pitch轴、左右移动控制Roll轴，但左右旋转控制Roll在减少视野变化的前提下效果也不错<br>
左右超前，上下追赶也许更贴近人的潜意识<br>
真实武器摆动里 yaw 幅度比 pitch/roll 小，roll（武器绕镜）更能体现质感。</p>
<h5 id="示例-1">
<a class="header-anchor" href="#%e7%a4%ba%e4%be%8b-1"></a>
示例
</h5><p>超前<br>
[tabs]</p>
<ul>
<li>UE5 教程1<br>
<a href="https://www.youtube.com/watch?v=rZUfkXaVvX4">https://www.youtube.com/watch?v=rZUfkXaVvX4</a><br>
教程中提到，给模型添加的SpringArm的方案效果并不好，因为无法限制他、并且很晃<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/PixPin_2025-11-26_07-20-24.gif" alt="|350"></li>
<li>UE5 教程2<br>
<a href="https://www.youtube.com/watch?v=YahaZR6Umxo">https://www.youtube.com/watch?v=YahaZR6Umxo</a><br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/PixPin_2025-11-26_07-23-44.gif" alt=""></li>
<li>UE5 教程3<br>
<a href="https://www.youtube.com/watch?v=eYsjiw0fXvU">https://www.youtube.com/watch?v=eYsjiw0fXvU</a><br>
视频中提到，我们可以反转参数来实现追赶效果。<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/PixPin_2025-11-27_01-33-44.gif" alt=""></li>
<li>UE 实例1<br>
<a href="https://www.youtube.com/watch?v=cpPOA6yKsoo">https://www.youtube.com/watch?v=cpPOA6yKsoo</a><br>
左右移动时采用roll旋转，鼠标X旋转用较小的Yaw，整体效果非常优秀<br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/PixPin_2025-11-27_17-35-54.mp4" alt=""></li>
</ul>
<p>追赶：<br>
[tabs]</p>
<ul>
<li>UE Example<br>
<a href="https://www.youtube.com/watch?v=MMvBRQtjFmQ">Realistic Weapon Sway In UE5</a><br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/PixPin_2025-11-27_01-30-43.gif" alt=""></li>
<li></li>
</ul>
<h4 id="围绕手武器偏移">
<a class="header-anchor" href="#%e5%9b%b4%e7%bb%95%e6%89%8b%e6%ad%a6%e5%99%a8%e5%81%8f%e7%a7%bb"></a>
围绕手/武器偏移
</h4><p><a href="https://www.youtube.com/watch?v=u9SuIsd7Dlw">https://www.youtube.com/watch?v=u9SuIsd7Dlw</a></p>
<h5 id="示例-2">
<a class="header-anchor" href="#%e7%a4%ba%e4%be%8b-2"></a>
示例
</h5><ul>
<li>军团要塞2<br>
<a href="https://www.youtube.com/watch?v=4wPAzutIVpc">Weapon Sway in Team Fortress 2 Again</a><br>
<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/PixPin_2025-11-27_16-40-17.gif" alt=""><br>
<a href="https://www.youtube.com/watch?v=Hu0v0kTWH7w">UFPS - Procedural camera &amp; animation system intro (2012)</a></li>
</ul>
<h4 id="围绕手武器旋转偏移">
<a class="header-anchor" href="#%e5%9b%b4%e7%bb%95%e6%89%8b%e6%ad%a6%e5%99%a8%e6%97%8b%e8%bd%ac%e5%81%8f%e7%a7%bb"></a>
围绕手/武器旋转+偏移
</h4><p>可以得到最符合直觉(不一定表现最强)的质感：玩家向右猛转→武器轻微绕镜顺转+向左偏移</p>
<h3 id="工程化">
<a class="header-anchor" href="#%e5%b7%a5%e7%a8%8b%e5%8c%96"></a>
工程化
</h3><h4 id="武器是追随视角还是超前视角">
<a class="header-anchor" href="#%e6%ad%a6%e5%99%a8%e6%98%af%e8%bf%bd%e9%9a%8f%e8%a7%86%e8%a7%92%e8%bf%98%e6%98%af%e8%b6%85%e5%89%8d%e8%a7%86%e8%a7%92"></a>
武器是“追随”视角还是“超前”视角？
</h4><p>有些游戏武器微微滞后（Lag）给人惯性感觉，有些武器反而“提前”给玩家视觉响应（Lead）以增强 responsiveness。根据游戏风格定。论坛中曾建议“leading”可以感觉更爽快。</p>
<h4 id="运动状态">
<a class="header-anchor" href="#%e8%bf%90%e5%8a%a8%e7%8a%b6%e6%80%81"></a>
运动状态
</h4><p>考虑不同运动状态下的视觉变化：<br>
[timeline]</p>
<ul>
<li>行走/跑动时：武器摆动幅度更大，速度更快，可能伴随武器上下小幅“抛物”运动 (bobbing) + sway。</li>
<li>站立/瞄准 (ADS)时：幅度缩小，响应延迟加大，甚至增加“惯性”感觉（武器慢慢跟上视角）。</li>
<li>蹲伏/匍匐：幅度最小，优雅/稳定感强。</li>
<li>跳跃/落地：瞬间武器有冲击位移＋摆动＋转动 →然后恢复。</li>
<li>武器切换、换弹、踢脚、滑行等动作也可以用类似机制增强反馈。<br>
当从跑→瞄或跳→落地，武器参数瞬间变化会感觉突兀。可以做跨状态插值（参数 lerp）或使用 timeline 让变化平滑。</li>
</ul>
<h4 id="屏幕震动">
<a class="header-anchor" href="#%e5%b1%8f%e5%b9%95%e9%9c%87%e5%8a%a8"></a>
屏幕震动
</h4><p>玩家视角旋转同时可能伴随镜头轻微晃动（camera bob/sway），建议武器摆动与镜头运动 <strong>不同步但联动</strong>。这会增强“手持武器真实”感。</p>
<h3 id="旋转ik_gun的yawpitch">
<a class="header-anchor" href="#%e6%97%8b%e8%bd%acik_gun%e7%9a%84yawpitch"></a>
旋转IK_Gun的Yaw/Pitch
</h3><p>最简单、最容易理解<br>
能达到的最好效果：<br>
<a href="https://www.youtube.com/watch?v=hCvq81uiDHU%5c&amp;list=PLnHeglBaPYu_BueK4IiXg34u5pGpsDkJj">SKG Shooter Framework</a>:采用SpringLerp，添加了一个类似LowPolyShooter的回弹效果</p>
<h3 id="额外效果">
<a class="header-anchor" href="#%e9%a2%9d%e5%a4%96%e6%95%88%e6%9e%9c"></a>
额外效果
</h3><p><a href="https://www.youtube.com/watch?v=hCvq81uiDHU%5c&amp;list=PLnHeglBaPYu_BueK4IiXg34u5pGpsDkJj"># SKG Shooter Framework</a>:添加了一个类似LowPolyShooter的回弹效果<br>
<a href="https://www.youtube.com/watch?v=kjVSLsz8dCs%5c&amp;source_ve_path=MTc4NDI0">COD2的武器摇摆</a><br>
获取输入量，使用动画Yaw和Pitch旋转</p>
<iframe width="100%" height="200px"  src="https://blueprintue.com/render/mw-zlw-z/" scrolling="no" allowfullscreen></iframe>
<h2 id="终极方案">
<a class="header-anchor" href="#%e7%bb%88%e6%9e%81%e6%96%b9%e6%a1%88"></a>
终极方案
</h2><p>DataAsset比Obj继承好的地方：可以编辑器实时编辑。修改父类数据后不用重新保存引用的蓝图<br>
Obj好的地方：可以单独存储函数中的数据、代码逻辑简单清晰、不需要独立Component用于计算</p>
<h3 id="代码">
<a class="header-anchor" href="#%e4%bb%a3%e7%a0%81"></a>
代码
</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UPawnComp_FPSRotWeaponSway</span><span class="o">::</span><span class="n">TickWeaponSway</span><span class="p">(</span><span class="kt">float</span> <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="k">const</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">ControlRotation</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bHasInput</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                <span class="n">ESwayState</span> <span class="n">NewState</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">DeltaSeconds</span> <span class="o">&lt;=</span> <span class="mf">0.f</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">LocalTime</span> <span class="o">+=</span> <span class="n">DeltaSeconds</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// State transitions  
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">NewState</span> <span class="o">!=</span> <span class="n">CurrentState</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>       <span class="n">CurrentState</span> <span class="o">=</span> <span class="n">NewState</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">       <span class="n">StateStartTime</span> <span class="o">=</span> <span class="n">LocalTime</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">FSwayParams</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">Params</span> <span class="o">=</span> <span class="n">GetParamsForState</span><span class="p">(</span><span class="n">CurrentState</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) delta rot  
</span></span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">deltaRot</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">NormalizedDeltaRotator</span><span class="p">(</span><span class="n">ControlRotation</span><span class="p">,</span> <span class="n">LastControlRot</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">LastControlRot</span> <span class="o">=</span> <span class="n">ControlRotation</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) rot speed (deg/s) and smoothing  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="nf">rotSpeedFrame</span><span class="p">(</span><span class="n">deltaRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="n">deltaRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// low-pass smoothing  
</span></span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">DeltaSeconds</span> <span class="o">*</span> <span class="mf">10.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// accel  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="nf">rotAccel</span><span class="p">((</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                       <span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) normalize  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="nf">rotSpeedNorm</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">/</span> <span class="n">Params</span><span class="p">.</span><span class="n">FiducialRotSpeed</span><span class="p">,</span> <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">/</span> <span class="n">Params</span><span class="p">.</span><span class="n">FiducialRotSpeed</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) nonlinear mapping (emphasize higher speeds)  
</span></span></span><span class="line"><span class="cl">    <span class="c1">//改为曲线，可以手动选择曲线  
</span></span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">NonLinear</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">float</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Sign</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Pow</span><span class="p">(</span><span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mf">1.15f</span><span class="p">);</span> <span class="p">};</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">NonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">NonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// 5) compute translation target  
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">swayOffsetTarget</span> <span class="o">=</span> <span class="n">FVector</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">       <span class="n">ny</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Z</span>  
</span></span><span class="line"><span class="cl">    <span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 6) compute rotation target (separate)  
</span></span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">rotTarget</span> <span class="o">=</span> <span class="n">FRotator</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">       <span class="n">ny</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">       <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Roll</span>  
</span></span><span class="line"><span class="cl">    <span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 7) lead/lag handling  
</span></span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">lagFactor</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">Params</span><span class="p">.</span><span class="n">LeadLag</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">lagFactor</span> <span class="o">&gt;</span> <span class="mf">0.f</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>       <span class="c1">// lag via 1st-order low pass  
</span></span></span><span class="line"><span class="cl">       <span class="kt">float</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="mf">0.02f</span><span class="p">,</span> <span class="mf">0.5f</span><span class="p">,</span> <span class="n">lagFactor</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="kt">float</span> <span class="n">k</span> <span class="o">=</span> <span class="n">DeltaSeconds</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="n">DeltaSeconds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">TargetOffsetFiltered</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">TargetOffsetFiltered</span><span class="p">,</span> <span class="n">swayOffsetTarget</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">TargetRotFiltered</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">TargetRotFiltered</span><span class="p">,</span> <span class="n">FVector</span><span class="p">(</span><span class="n">rotTarget</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">rotTarget</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">rotTarget</span><span class="p">.</span><span class="n">Roll</span><span class="p">),</span> <span class="n">k</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">swayOffsetTarget</span> <span class="o">=</span> <span class="n">TargetOffsetFiltered</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">       <span class="n">rotTarget</span> <span class="o">=</span> <span class="n">FRotator</span><span class="p">(</span><span class="n">TargetRotFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">TargetRotFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">TargetRotFiltered</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>    <span class="c1">//问题，数值不影响最终效果  
</span></span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">lagFactor</span> <span class="o">&lt;</span> <span class="mf">0.f</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>       <span class="c1">// small predictive lead using angular accel  
</span></span></span><span class="line"><span class="cl">       <span class="kt">float</span> <span class="n">leadAmp</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">lagFactor</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">       <span class="n">swayOffsetTarget</span> <span class="o">+=</span> <span class="n">FVector</span><span class="p">(</span><span class="n">rotAccel</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="n">rotAccel</span><span class="p">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span> <span class="o">*</span> <span class="n">leadAmp</span> <span class="o">*</span> <span class="mf">0.02f</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">       <span class="n">rotTarget</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">+=</span> <span class="n">rotAccel</span><span class="p">.</span><span class="n">Y</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">*</span> <span class="n">leadAmp</span> <span class="o">*</span> <span class="mf">0.01f</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 8) state ramp and idle noise  
</span></span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">stateRamp</span> <span class="o">=</span> <span class="n">ComputeStateRamp</span><span class="p">(</span><span class="n">Params</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// if (!bHasInput &amp;&amp; FVector2D(rotSpeedNorm).SizeSquared() &lt; 0.01f)  
</span></span></span><span class="line"><span class="cl">    <span class="c1">// {    //     FVector noise = GetIdleNoise(LocalTime) * Params.IdleNoiseAmp;    //     swayOffsetTarget += noise * 0.3f * stateRamp;    //     rotTarget += FRotator(noise.Z * Params.IdleNoiseRotAmp * 0.2f, noise.X * Params.IdleNoiseRotAmp * 0.15f,    //                           noise.Y * Params.IdleNoiseRotAmp * 0.25f);    // }  
</span></span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">swayOffsetTarget</span> <span class="o">*=</span> <span class="n">stateRamp</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rotTarget</span> <span class="o">=</span> <span class="n">rotTarget</span> <span class="o">*</span> <span class="n">stateRamp</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 9) position spring interp  
</span></span></span><span class="line"><span class="cl">    <span class="n">SwayOffset</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">VectorSpringInterp</span><span class="p">(</span><span class="n">SwayOffset</span><span class="p">,</span> <span class="n">swayOffsetTarget</span><span class="p">,</span> <span class="n">PosSpringState</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                        <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Damping</span><span class="p">,</span> <span class="n">DeltaSeconds</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                                        <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Mass</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 10) rotation spring interp  
</span></span></span><span class="line"><span class="cl">    <span class="n">SwayRot</span> <span class="o">=</span> <span class="n">RotatorSpringInterp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">,</span> <span class="n">rotTarget</span><span class="p">,</span> <span class="n">RotSpringState</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Damping</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                                  <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Mass</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// 11) clamp  
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">SwayOffset</span><span class="p">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">)</span> <span class="n">SwayOffset</span> <span class="o">=</span> <span class="n">SwayOffset</span><span class="p">.</span><span class="n">GetSafeNormal</span><span class="p">()</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">SwayRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="o">-</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">SwayRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="o">-</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">SwayRot</span><span class="p">.</span><span class="n">Roll</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">,</span> <span class="o">-</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="步骤">
<a class="header-anchor" href="#%e6%ad%a5%e9%aa%a4"></a>
步骤
</h3><h4 id="1-计算瞬时角速度">
<a class="header-anchor" href="#1-%e8%ae%a1%e7%ae%97%e7%9e%ac%e6%97%b6%e8%a7%92%e9%80%9f%e5%ba%a6"></a>
1. 计算瞬时角速度
</h4><p>得到当前帧相对上一帧的欧拉角差（通常取 Yaw 和 Pitch），用于计算瞬时角速度（deg/s）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FRotator</span> <span class="n">deltaRot</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">NormalizedDeltaRotator</span><span class="p">(</span><span class="n">ControlRotation</span><span class="p">,</span> <span class="n">LastControlRot</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="n">LastControlRot</span> <span class="o">=</span> <span class="n">ControlRotation</span><span class="p">;</span>
</span></span></code></pre></div><p>NormalizedDeltaRotator: 将差异角度控制在[-180, 180]之间</p>
<h4 id="2-低通滤波--平滑角速度加速度rotspeedfiltered">
<a class="header-anchor" href="#2-%e4%bd%8e%e9%80%9a%e6%bb%a4%e6%b3%a2--%e5%b9%b3%e6%bb%91%e8%a7%92%e9%80%9f%e5%ba%a6%e5%8a%a0%e9%80%9f%e5%ba%a6rotspeedfiltered"></a>
2. 低通滤波 / 平滑角速度/加速度（RotSpeedFiltered）
</h4><p>对每帧测得的角速度做指数平滑（低通），去掉抖动 / 鼠标抖动(0.1s内)造成的高频噪声。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FVector2D</span> <span class="nf">rotSpeedFrame</span><span class="p">(</span><span class="n">deltaRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="n">deltaRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">// low-pass smoothing  
</span></span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">DeltaSeconds</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">.1f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">rotSpeedFrame</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="c1">// accel  
</span></span></span><span class="line"><span class="cl"><span class="n">FVector2D</span> <span class="nf">rotAccel</span><span class="p">((</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">-</span> <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                   <span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">-</span> <span class="n">PrevRotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="n">DeltaSeconds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="n">PrevRotSpeedFiltered</span> <span class="o">=</span> <span class="n">RotSpeedFiltered</span><span class="p">;</span>  
</span></span></code></pre></div><h4 id="3-归一化角速度fiducialrotspeed">
<a class="header-anchor" href="#3-%e5%bd%92%e4%b8%80%e5%8c%96%e8%a7%92%e9%80%9f%e5%ba%a6fiducialrotspeed"></a>
3. 归一化角速度（fiducialRotSpeed）
</h4><p>把角速度映射到 [-1,1] 范围,玩家鼠标灵敏度差异很大，归一化允许统一调参（例如把 180°/s 视为“满值”）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FVector2D</span> <span class="nf">rotSpeedNorm</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">X</span> <span class="o">/</span> <span class="n">Params</span><span class="p">.</span><span class="n">FiducialRotSpeed</span><span class="p">,</span> <span class="n">RotSpeedFiltered</span><span class="p">.</span><span class="n">Y</span> <span class="o">/</span> <span class="n">Params</span><span class="p">.</span><span class="n">FiducialRotSpeed</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
</span></span></code></pre></div><p>FiducialRotSpeed: 每秒转速，可以设为1440，4圈</p>
<h4 id="4-非线性映射例如-powsign">
<a class="header-anchor" href="#4-%e9%9d%9e%e7%ba%bf%e6%80%a7%e6%98%a0%e5%b0%84%e4%be%8b%e5%a6%82-powsign"></a>
4. 非线性映射（例如 pow/sign）
</h4><p>把归一化速度做非线性压缩或放大（低速更线性/柔和、高速更敏感），用来塑造手感曲线。微小头部移动只想要极小响应，而大幅快速转头希望响应更加明显。非线性函数（如 pow）能实现这种“阈值感”。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">NonLinear</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">float</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Sign</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Pow</span><span class="p">(</span><span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mf">1.15f</span><span class="p">);</span> <span class="p">};</span>  
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">NonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">NonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>
</span></span></code></pre></div><p>NonLinear:可以换成曲线映射[0,1]<br>
Pow: 可以调更高或设置为参数</p>
<h4 id="5-计算目标偏移与旋转swayoffsettarget--rottarget">
<a class="header-anchor" href="#5-%e8%ae%a1%e7%ae%97%e7%9b%ae%e6%a0%87%e5%81%8f%e7%a7%bb%e4%b8%8e%e6%97%8b%e8%bd%acswayoffsettarget--rottarget"></a>
5. 计算目标偏移与旋转（swayOffsetTarget / rotTarget）
</h4><p>在真实枪械中，Pitch、Roll、Yaw 的来源与幅度不同（例如 yaw 小，roll 明显），把它们分开能分别调节惯性与幅度。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 5) compute translation target  
</span></span></span><span class="line"><span class="cl"><span class="n">FVector</span> <span class="n">swayOffsetTarget</span> <span class="o">=</span> <span class="n">FVector</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">    <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">ny</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Z</span>  
</span></span><span class="line"><span class="cl"><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// 6) compute rotation target (separate)  
</span></span></span><span class="line"><span class="cl"><span class="n">FRotator</span> <span class="n">rotTarget</span> <span class="o">=</span> <span class="n">FRotator</span><span class="p">(</span>  
</span></span><span class="line"><span class="cl">    <span class="n">ny</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Roll</span>  
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></div><h4 id="6-lead--lag滞后或超前处理">
<a class="header-anchor" href="#6-lead--lag%e6%bb%9e%e5%90%8e%e6%88%96%e8%b6%85%e5%89%8d%e5%a4%84%e7%90%86"></a>
6. Lead / Lag（滞后或超前）处理
</h4><p>根据 <code>Params.LeadLag</code>，做一阶低通（lag）或简单预测（lead）。<br>
控制武器对视角的响应是“稍滞后”（更真实/有惯性）还是“略超前”（更敏捷/竞技感）。</p>
<ul>
<li>Lag：武器在转动停止后会有尾巴（overshoot + decay） → 更真实但反应稍慢；</li>
<li>Lead：能让瞄准看起来更准/快速（适合竞技风格）；</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">lagFactor</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">Params</span><span class="p">.</span><span class="n">LeadLag</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">lagFactor</span> <span class="o">&gt;</span> <span class="mf">0.f</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// lag via 1st-order low pass  
</span></span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="mf">0.02f</span><span class="p">,</span> <span class="mf">0.5f</span><span class="p">,</span> <span class="n">lagFactor</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">k</span> <span class="o">=</span> <span class="n">DeltaSeconds</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="n">DeltaSeconds</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">TargetOffsetFiltered</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">TargetOffsetFiltered</span><span class="p">,</span> <span class="n">swayOffsetTarget</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">TargetRotFiltered</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">TargetRotFiltered</span><span class="p">,</span> <span class="n">FVector</span><span class="p">(</span><span class="n">rotTarget</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">rotTarget</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">rotTarget</span><span class="p">.</span><span class="n">Roll</span><span class="p">),</span> <span class="n">k</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">swayOffsetTarget</span> <span class="o">=</span> <span class="n">TargetOffsetFiltered</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rotTarget</span> <span class="o">=</span> <span class="n">FRotator</span><span class="p">(</span><span class="n">TargetRotFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">TargetRotFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">TargetRotFiltered</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">lagFactor</span> <span class="o">&lt;</span> <span class="mf">0.f</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// small predictive lead using angular accel  
</span></span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">leadAmp</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">lagFactor</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">swayOffsetTarget</span> <span class="o">+=</span> <span class="n">FVector</span><span class="p">(</span><span class="n">rotAccel</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="n">rotAccel</span><span class="p">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span> <span class="o">*</span> <span class="n">leadAmp</span> <span class="o">*</span> <span class="mf">0.02f</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="n">rotTarget</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">+=</span> <span class="n">rotAccel</span><span class="p">.</span><span class="n">Y</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">*</span> <span class="n">leadAmp</span> <span class="o">*</span> <span class="mf">0.01f</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="8-状态延迟与-rampstateentrydelay--stateramptime">
<a class="header-anchor" href="#8-%e7%8a%b6%e6%80%81%e5%bb%b6%e8%bf%9f%e4%b8%8e-rampstateentrydelay--stateramptime"></a>
8. 状态延迟与 Ramp（StateEntryDelay / StateRampTime）
</h4><p>在状态切换（如进入 ADS）时给出延迟和渐入（例如瞄准后不是瞬间从“跑步晃动”变为“稳态”，而是有个缓慢过渡）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">stateRamp</span> <span class="o">=</span> <span class="n">ComputeStateRamp</span><span class="p">(</span><span class="n">Params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">swayOffsetTarget</span> <span class="o">*=</span> <span class="n">stateRamp</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="n">rotTarget</span> <span class="o">=</span> <span class="n">rotTarget</span> <span class="o">*</span> <span class="n">stateRamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">ComputeStateRamp</span><span class="p">(</span><span class="k">const</span> <span class="n">FSwayParams</span><span class="o">&amp;</span> <span class="n">Params</span><span class="p">)</span> <span class="k">const</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">Elapsed</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Max</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="n">LocalTime</span> <span class="o">-</span> <span class="n">StateStartTime</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">Elapsed</span> <span class="o">&lt;</span> <span class="n">Params</span><span class="p">.</span><span class="n">StateEntryDelay</span><span class="p">)</span> <span class="k">return</span> <span class="mf">0.f</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">AfterDelay</span> <span class="o">=</span> <span class="n">Elapsed</span> <span class="o">-</span> <span class="n">Params</span><span class="p">.</span><span class="n">StateEntryDelay</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">Params</span><span class="p">.</span><span class="n">StateRampTime</span> <span class="o">&lt;=</span> <span class="n">KINDA_SMALL_NUMBER</span><span class="p">)</span> <span class="k">return</span> <span class="mf">1.f</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">AfterDelay</span> <span class="o">/</span> <span class="n">Params</span><span class="p">.</span><span class="n">StateRampTime</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="9-弹簧插值vectorspringinterp">
<a class="header-anchor" href="#9-%e5%bc%b9%e7%b0%a7%e6%8f%92%e5%80%bcvectorspringinterp"></a>
9. 弹簧插值（VectorSpringInterp）
</h4><p>用弹簧阻尼模型使当前位置朝目标平滑过渡，并能表现出惯性、超调（如果阻尼不足）或快速回弹（如果阻尼大）。<br>
弹簧模型比简单的 LERP 更接近物理，能自然模拟质量、刚度、阻尼的不同组合，产生丰富的“尾巴/回弹”效果。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">SwayOffset</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">VectorSpringInterp</span><span class="p">(</span><span class="n">SwayOffset</span><span class="p">,</span><span class="n">swayOffsetTarget</span><span class="p">,</span> <span class="n">PosSpringState</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Damping</span><span class="p">,</span> <span class="n">DeltaSeconds</span><span class="p">,</span>  <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Mass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">SwayRot</span> <span class="o">=</span> <span class="n">RotatorSpringInterp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">,</span> <span class="n">rotTarget</span><span class="p">,</span> <span class="n">RotSpringState</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Damping</span><span class="p">,</span> <span class="n">DeltaSeconds</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Mass</span><span class="p">);</span>
</span></span></code></pre></div><p>旋转弹簧插值：社区推荐用自己的弹簧求解<a href="https://toqoz.fyi/springs.html?utm_source=chatgpt.com">Spring-based Animation and Quaternions</a></p>
<h4 id="10-限幅maxoffset--maxpitchyawroll">
<a class="header-anchor" href="#10-%e9%99%90%e5%b9%85maxoffset--maxpitchyawroll"></a>
10. 限幅（MaxOffset / MaxPitch/Yaw/Roll）
</h4><p>保护视觉（防止武器飘出画面或产生穿模），并保证在极端输入下效果可控。<br>
用户灵敏度、鼠标抖动或跳帧可能造成瞬时超大值，限幅能保护不破坏玩家视觉体验。上述情况都很容易出现</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">SwayOffset</span><span class="p">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">)</span> <span class="n">SwayOffset</span> <span class="o">=</span> <span class="n">SwayOffset</span><span class="p">.</span><span class="n">GetSafeNormal</span><span class="p">()</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="n">SwayRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="o">-</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="n">SwayRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="o">-</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="n">SwayRot</span><span class="p">.</span><span class="n">Roll</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">SwayRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">,</span> <span class="o">-</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>
</span></span></code></pre></div><h4 id="buttstockpivotyaw-绕枪托旋转在-animbp-中的实现">
<a class="header-anchor" href="#buttstockpivotyaw-%e7%bb%95%e6%9e%aa%e6%89%98%e6%97%8b%e8%bd%ac%e5%9c%a8-animbp-%e4%b8%ad%e7%9a%84%e5%ae%9e%e7%8e%b0"></a>
ButtStockPivot（Yaw 绕枪托旋转）在 AnimBP 中的实现
</h4><p>AnimBP 中 <code>Transform (Modify) Bone</code> 节点对 <code>ButtStockPivot</code> 应用 <code>SwayRot.Yaw</code>，而 Pitch/Roll 应用在 WeaponBody/root。<br>
把绕 Yaw 的旋转枢轴定位在枪托（贴肩处），保证枪托相对稳定，枪口移动最大，符合现实杠杆效果。<br>
<strong>为什么</strong>：现实中枪托靠肩为固定支点，绕该点左右偏转时枪口的位移最大；若绕武器根或中心旋转，会让枪显得“漂浮”。</p>
<h2 id="未处理的资料">
<a class="header-anchor" href="#%e6%9c%aa%e5%a4%84%e7%90%86%e7%9a%84%e8%b5%84%e6%96%99"></a>
未处理的资料
</h2><p><a href="https://forums.unrealengine.com/t/weapon-sway-solved/326436">Weapon sway Solved</a></p>
<h3 id="gpt建议">
<a class="header-anchor" href="#gpt%e5%bb%ba%e8%ae%ae"></a>
GPT建议
</h3><table>
  <thead>
      <tr>
          <th><strong>你的实现</strong></th>
          <th><strong>AAA /研究 /行业参考</strong></th>
          <th><strong>建议 &amp; 调整方向</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>使用鼠标转向速度 (deltaRot) 计算转速 → 归一化 → 目标偏移 (swayOffset_Target) → 弹簧插值恢复</td>
          <td>真实游戏 /研究中常用弹簧插值 + 惯性 + 超调 + lag/lead</td>
          <td>保持弹簧插值，但调参数 (Stiffness, Mass, Damping) 来实现 <strong>超调 + 回弹</strong>。考虑你希望武器在停止输入后有“惯性尾巴 (trail)” + 轻微 overshoot。</td>
      </tr>
      <tr>
          <td>偏移 (swayOffset) 驱动旋转 (swayRot)（简单线性系数映射）</td>
          <td>AAA 项目中旋转 (pitch / yaw / roll) 往往与速度 +惯性分开处理，有自己的惯性插值</td>
          <td>把旋转 (swayRot) 用自己的弹簧插值 (或类似) 系统，而不是直接从偏移映射。这样旋转也有惯性感觉 (滞后/lead + 回弹)。特别是 roll（武器绕镜转）可以很大程度提升真实感。</td>
      </tr>
      <tr>
          <td>早期退出逻辑：如果无输入且偏移、旋转近零就不计算</td>
          <td>AAA 设计中，他们通常不会完全关掉 sway 恢复 / idle 状态 — 武器在静止时也可能有 /启动 idle sway</td>
          <td>改进早退策略：即使无输入，也持续更新直到偏移 &amp; 旋转真正回中性。加入 <strong>idle sway</strong> (微小自然晃动)，而不是硬性归零。</td>
      </tr>
      <tr>
          <td>参数固定 (swayOffsetMulti、旋转倍率、多项弹簧参数)</td>
          <td>AAA 游戏通常根据 “武器类型 +玩家姿态 (站/蹲/跑) +附件” 调整 sway 参数 (Vigor 是一个例子)</td>
          <td>将你的系统做成 <strong>状态驱动 (state-based)</strong>：不同姿态 (跑 /站 /瞄准 /蹲) 使用不同参数集 (偏移倍率、弹簧刚度、最大转速等)。这样你可以模仿 AAA 级别多样性的武器手感。</td>
      </tr>
      <tr>
          <td>只用角速度 (转速) 来决定目标偏移</td>
          <td>研究 /现实中武器响应玩家视角转动时可能有 “leading / lagging” + 超调 + 惯性恢复</td>
          <td>引入 “lead vs lag” 参数：你可以计算目标偏移不仅基于速度，还考虑 “前一帧偏移 (或旋转)” 的惯性趋势 (例如让武器略滞后然后缓慢回弹)，模拟惯性 + 质量感。</td>
      </tr>
      <tr>
          <td>不考虑 “delay / ramp-up”</td>
          <td>CoD 等 AAA 游戏在 ADS 时给 idle sway 加了 <strong>延迟 (delay)</strong> + 逐渐增强 (ramp up)</td>
          <td>给你的 swayTarget 或旋转目标引入一个 <strong>启动 delay + 增强曲线</strong>，特别是在进入瞄准 (ADS) 时。这样视觉效果更自然，也更贴近 AAA 设计。</td>
      </tr>
      <tr>
          <td>没有限制最大偏移 /旋转 (或你自己 clamp)</td>
          <td>AAA 游戏为了避免视觉偏移太过夸张，一般会对摆动幅度 (translation + rotation) 设上限</td>
          <td>明确定义最大偏移和最大旋转 (sway 限值)，防止在高速转向或极端情况时武器 “飞出画面” 或摆动过度。还可以让这些最大值随武器类别 /状态动态变化。</td>
      </tr>
      <tr>
          <td>不考虑武器重量 /惯性随武器差异</td>
          <td>社区 (如 Escape from Tarkov 玩家)经常提到 “武器重量 (mass) 应影响 sway /惯性”。 (<a href="https://www.reddit.com/r/EscapefromTarkov/comments/fgohpd?utm_source=chatgpt.com" title="Weight should directly influence weapon sway">Reddit</a>)</td>
          <td>如果你的游戏里有不同武器 (轻步枪、重机枪等)，可以将 <strong>Mass</strong> (弹簧质量) 参数与武器重量 (或重量感) 关联，使 “重武器摇晃慢、惯性大” 这样更真实。</td>
      </tr>
      <tr>
          <td>没有加入自然微抖 (noise)</td>
          <td>社区 /开发者经常使用 Perlin 噪声 / Lissajous 曲线来模拟 idle sway。 r/gamedev 上就有提到。 (<a href="https://www.reddit.com/r/gamedev/comments/3m548h/techniques_for_weapon_sway_in_fps/?utm_source=chatgpt.com" title="Techniques for weapon sway in FPS : r/gamedev">Reddit</a>)</td>
          <td>加入 <strong>程序噪声 (Perlin noise) 或 Lissajous 曲线</strong> 来生成 idle 摆动 (手抖 /呼吸效果)，让静止时武器也不死板。结合你弹簧系统做一个混合机制 (惯性 + 噪声)。</td>
      </tr>
  </tbody>
</table>
<h4 id="三小结--推荐下一步">
<a class="header-anchor" href="#%e4%b8%89%e5%b0%8f%e7%bb%93--%e6%8e%a8%e8%8d%90%e4%b8%8b%e4%b8%80%e6%ad%a5"></a>
三、小结 + 推荐下一步
</h4><ul>
<li>[ ] <strong>加入更丰富的动态 (延迟、超调、lead/lag、惯性恢复)</strong>，大幅提升逼真感 /重量感。</li>
<li>[ ] 做 <strong>状态驱动 (state-based)</strong> 参数集 (站、跑、蹲、瞄准) 是非常重要的一步，使武器摆动在不同战况下显得差异化和有“手感层次”。</li>
<li>[ ] 引入 <strong>自然噪声 (Perlin / Lissajous)</strong> 用以 idle 微抖，会让武器看起来更“活”，玩家感觉手持感 +真实感强。</li>
<li>[ ] 参数调节</li>
</ul>
<h4 id="代码-1">
<a class="header-anchor" href="#%e4%bb%a3%e7%a0%81-1"></a>
代码
</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Utility: RotatorSpringInterp (实现与 VectorSpringInterp 类似)
</span></span></span><span class="line"><span class="cl"><span class="n">FRotator</span> <span class="nf">RotatorSpringInterp</span><span class="p">(</span><span class="k">const</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">Current</span><span class="p">,</span> <span class="k">const</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">Target</span><span class="p">,</span> <span class="n">FRotatorSpringState</span><span class="o">&amp;</span> <span class="n">State</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                             <span class="kt">float</span> <span class="n">Stiffness</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Damping</span><span class="p">,</span> <span class="kt">float</span> <span class="n">DeltaTime</span><span class="p">,</span> <span class="kt">float</span> <span class="n">Mass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里给出简化数值积分（显式欧拉或 semi-implicit），在工程中你可以用更稳健的求解器
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">FVector</span><span class="p">(</span><span class="n">Current</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">Current</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">Current</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">targ</span> <span class="o">=</span> <span class="n">FVector</span><span class="p">(</span><span class="n">Target</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">Target</span><span class="p">.</span><span class="n">Roll</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// velocity stored in State (as FVector)
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">targ</span> <span class="o">-</span> <span class="n">cur</span><span class="p">)</span> <span class="o">*</span> <span class="n">Stiffness</span> <span class="o">-</span> <span class="n">State</span><span class="p">.</span><span class="n">Velocity</span> <span class="o">*</span> <span class="n">Damping</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">acc</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">/</span> <span class="n">Mass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">State</span><span class="p">.</span><span class="n">Velocity</span> <span class="o">+=</span> <span class="n">acc</span> <span class="o">*</span> <span class="n">DeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">next</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">+</span> <span class="n">State</span><span class="p">.</span><span class="n">Velocity</span> <span class="o">*</span> <span class="n">DeltaTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">FRotator</span><span class="p">(</span><span class="n">next</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">next</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 改良 WeaponSway_Look
</span></span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UUCharacterAnimHelpComp</span><span class="o">::</span><span class="n">WeaponSway_Look</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span><span class="o">&amp;</span> <span class="n">swayOffset</span><span class="p">,</span> <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">swayRot</span><span class="p">,</span> <span class="n">FVectorSpringState</span><span class="o">&amp;</span> <span class="n">PosSpringState</span><span class="p">,</span> <span class="n">FRotatorSpringState</span><span class="o">&amp;</span> <span class="n">RotSpringState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">FRotator</span><span class="o">&amp;</span> <span class="n">lastControllerRot</span><span class="p">,</span> <span class="kt">float</span> <span class="n">deltaSeconds</span><span class="p">,</span> <span class="k">const</span> <span class="n">FSwayParams</span><span class="o">&amp;</span> <span class="n">Params</span><span class="p">,</span> <span class="n">ESwayState</span> <span class="n">CurrentState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">CurrentTime</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bHasInput</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">deltaSeconds</span> <span class="o">&lt;=</span> <span class="n">KINDA_SMALL_NUMBER</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) 获取控制旋转并计算 delta
</span></span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">currentControl</span> <span class="o">=</span> <span class="n">GetPawn</span><span class="o">&lt;</span><span class="n">APawn</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetControlRotation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">deltaRot</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">NormalizedDeltaRotator</span><span class="p">(</span><span class="n">currentControl</span><span class="p">,</span> <span class="n">lastControllerRot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lastControllerRot</span> <span class="o">=</span> <span class="n">currentControl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) 角速度 (deg/s) and accel
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="nf">rotSpeedFrame</span><span class="p">(</span><span class="n">deltaRot</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">/</span> <span class="n">deltaSeconds</span><span class="p">,</span> <span class="n">deltaRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">/</span> <span class="n">deltaSeconds</span><span class="p">);</span> <span class="c1">// yaw, pitch
</span></span></span><span class="line"><span class="cl">    <span class="c1">// 用低通滤波平滑 rotSpeed（成员变量：PrevRotSpeedFiltered）
</span></span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span> <span class="n">deltaSeconds</span> <span class="o">*</span> <span class="mf">10.f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="mf">1.0f</span> <span class="p">);</span> <span class="c1">// time constant
</span></span></span><span class="line"><span class="cl">    <span class="n">RotSpeedFiltered</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">RotSpeedFiltered</span><span class="p">,</span> <span class="n">rotSpeedFrame</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span> <span class="c1">// FVector2D stored
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="n">rotAccel</span> <span class="o">=</span> <span class="p">(</span><span class="n">RotSpeedFiltered</span> <span class="o">-</span> <span class="n">PrevRotSpeedFiltered</span><span class="p">)</span> <span class="o">/</span> <span class="n">deltaSeconds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PrevRotSpeedFiltered</span> <span class="o">=</span> <span class="n">RotSpeedFiltered</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) 归一化速度（参考 fiducial）
</span></span></span><span class="line"><span class="cl">    <span class="n">FVector2D</span> <span class="n">rotSpeedNorm</span> <span class="o">=</span> <span class="n">RotSpeedFiltered</span> <span class="o">/</span> <span class="n">Params</span><span class="p">.</span><span class="n">FiducialRotSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) 生成目标偏移（translation）——可以用非线性映射，增加高速度响应
</span></span></span><span class="line"><span class="cl">    <span class="c1">// 使用曲线: sign * pow(abs(norm), 1.2) 可以让高转速更敏感
</span></span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">nonLinear</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">float</span> <span class="n">v</span><span class="p">){</span> <span class="k">return</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Sign</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Pow</span><span class="p">(</span><span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mf">1.2f</span><span class="p">);</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">nonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">X</span><span class="p">),</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">nonLinear</span><span class="p">(</span><span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FVector</span> <span class="n">swayOffsetTarget</span> <span class="o">=</span> <span class="n">FVector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>       <span class="c1">// yaw → lateral opposite
</span></span></span><span class="line"><span class="cl">        <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>              <span class="c1">// yaw → forward/back small
</span></span></span><span class="line"><span class="cl">        <span class="n">ny</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span><span class="p">.</span><span class="n">Z</span>               <span class="c1">// pitch → vertical
</span></span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 5) 旋转目标（rotation）单独计算（不要从位置直接映射）
</span></span></span><span class="line"><span class="cl">    <span class="n">FRotator</span> <span class="n">rotTarget</span> <span class="o">=</span> <span class="n">FRotator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">ny</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="c1">// pitch
</span></span></span><span class="line"><span class="cl">        <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span>   <span class="c1">// yaw (we&#39;ll later apply yaw on shoulder pivot)
</span></span></span><span class="line"><span class="cl">        <span class="n">nx</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Roll</span>          <span class="c1">// roll, responsive to yaw
</span></span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 6) 应用 Lead/Lag：对 target 做滞后（exponential）让武器滞后视角
</span></span></span><span class="line"><span class="cl">    <span class="c1">// 这里用简单的一阶低通滤波来实现 lag；当 LeadLag &lt; 0 可变成带超前逻辑（更复杂）
</span></span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">lagFactor</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">Params</span><span class="p">.</span><span class="n">LeadLag</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">lagFactor</span> <span class="o">&gt;</span> <span class="mf">0.f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// lag amount (0..1)
</span></span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="mf">0.02f</span><span class="p">,</span> <span class="mf">0.5f</span><span class="p">,</span> <span class="n">lagFactor</span><span class="p">);</span> <span class="c1">// time constant
</span></span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">k</span> <span class="o">=</span> <span class="n">deltaSeconds</span> <span class="o">/</span> <span class="p">(</span><span class="n">tau</span> <span class="o">+</span> <span class="n">deltaSeconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">TargetOffsetFiltered</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">TargetOffsetFiltered</span><span class="p">,</span> <span class="n">swayOffsetTarget</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">TargetRotFiltered</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Lerp</span><span class="p">(</span><span class="n">TargetRotFiltered</span><span class="p">,</span> <span class="n">FVector</span><span class="p">(</span><span class="n">rotTarget</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="n">rotTarget</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span> <span class="n">rotTarget</span><span class="p">.</span><span class="n">Roll</span><span class="p">),</span> <span class="n">k</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">swayOffsetTarget</span> <span class="o">=</span> <span class="n">TargetOffsetFiltered</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">rotTarget</span> <span class="o">=</span> <span class="n">FRotator</span><span class="p">(</span><span class="n">TargetRotFiltered</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">TargetRotFiltered</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">TargetRotFiltered</span><span class="p">.</span><span class="n">Z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">lagFactor</span> <span class="o">&lt;</span> <span class="mf">0.f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// light lead: apply small predictive term using rotAccel
</span></span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">leadAmp</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Abs</span><span class="p">(</span><span class="n">lagFactor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">swayOffsetTarget</span> <span class="o">+=</span> <span class="n">FVector</span><span class="p">(</span><span class="n">rotAccel</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">,</span> <span class="n">rotAccel</span><span class="p">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span> <span class="o">*</span> <span class="n">leadAmp</span> <span class="o">*</span> <span class="mf">0.05f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">rotTarget</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">+=</span> <span class="n">rotAccel</span><span class="p">.</span><span class="n">Y</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">*</span> <span class="n">leadAmp</span> <span class="o">*</span> <span class="mf">0.02f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 7) 在没有输入时处理 idle noise &amp; state ramp
</span></span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">stateRamp</span> <span class="o">=</span> <span class="n">ComputeStateRamp</span><span class="p">(</span><span class="n">CurrentState</span><span class="p">,</span> <span class="n">CurrentTime</span><span class="p">,</span> <span class="n">Params</span><span class="p">);</span> <span class="c1">// returns 0..1 according to delay/rampTime
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bHasInput</span> <span class="o">&amp;&amp;</span> <span class="n">rotSpeedNorm</span><span class="p">.</span><span class="n">SizeSquared</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.01f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Idle noise — 小幅 Perlin 或 Lissajous
</span></span></span><span class="line"><span class="cl">        <span class="n">FVector</span> <span class="n">noise</span> <span class="o">=</span> <span class="n">GetIdleNoise</span><span class="p">(</span><span class="n">CurrentTime</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01f</span><span class="p">;</span> <span class="c1">// e.g., returns ~[-1,1]
</span></span></span><span class="line"><span class="cl">        <span class="n">swayOffsetTarget</span> <span class="o">+=</span> <span class="n">noise</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayOffsetMulti</span> <span class="o">*</span> <span class="mf">0.3f</span> <span class="o">*</span> <span class="n">stateRamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// small rotational noise:
</span></span></span><span class="line"><span class="cl">        <span class="n">rotTarget</span> <span class="o">+=</span> <span class="n">FRotator</span><span class="p">(</span><span class="n">noise</span><span class="p">.</span><span class="n">Z</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">*</span> <span class="mf">0.2f</span><span class="p">,</span> <span class="n">noise</span><span class="p">.</span><span class="n">X</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Yaw</span> <span class="o">*</span> <span class="mf">0.15f</span><span class="p">,</span> <span class="n">noise</span><span class="p">.</span><span class="n">Y</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">SwayRotMulti</span><span class="p">.</span><span class="n">Roll</span> <span class="o">*</span> <span class="mf">0.25f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">swayOffsetTarget</span> <span class="o">*=</span> <span class="n">stateRamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rotTarget</span> <span class="o">=</span> <span class="n">rotTarget</span> <span class="o">*</span> <span class="n">stateRamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 8) 弹簧插值（位置）
</span></span></span><span class="line"><span class="cl">    <span class="n">swayOffset</span> <span class="o">=</span> <span class="n">UKismetMathLibrary</span><span class="o">::</span><span class="n">VectorSpringInterp</span><span class="p">(</span><span class="n">swayOffset</span><span class="p">,</span> <span class="n">swayOffsetTarget</span><span class="p">,</span> <span class="n">PosSpringState</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Damping</span><span class="p">,</span> <span class="n">deltaSeconds</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Pos_Mass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 9) 旋转弹簧插值
</span></span></span><span class="line"><span class="cl">    <span class="n">swayRot</span> <span class="o">=</span> <span class="n">RotatorSpringInterp</span><span class="p">(</span><span class="n">swayRot</span><span class="p">,</span> <span class="n">rotTarget</span><span class="p">,</span> <span class="n">RotSpringState</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Stiffness</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Damping</span><span class="p">,</span> <span class="n">deltaSeconds</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">Rot_Mass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 10) 限幅
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">swayOffset</span><span class="p">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">swayOffset</span> <span class="o">=</span> <span class="n">swayOffset</span><span class="p">.</span><span class="n">GetSafeNormal</span><span class="p">()</span> <span class="o">*</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxOffset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">swayRot</span><span class="p">.</span><span class="n">Pitch</span> <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">swayRot</span><span class="p">.</span><span class="n">Pitch</span><span class="p">,</span> <span class="o">-</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxPitch</span><span class="p">,</span> <span class="n">Params</span><span class="p">.</span><span class="n">MaxPitch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">swayRot</span><span class="p">.</span><span class="n">Yaw</span>   <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">swayRot</span><span class="p">.</span><span class="n">Yaw</span><span class="p">,</span>   <span class="o">-</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxYaw</span><span class="p">,</span>   <span class="n">Params</span><span class="p">.</span><span class="n">MaxYaw</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">swayRot</span><span class="p">.</span><span class="n">Roll</span>  <span class="o">=</span> <span class="n">FMath</span><span class="o">::</span><span class="n">Clamp</span><span class="p">(</span><span class="n">swayRot</span><span class="p">.</span><span class="n">Roll</span><span class="p">,</span>  <span class="o">-</span><span class="n">Params</span><span class="p">.</span><span class="n">MaxRoll</span><span class="p">,</span>  <span class="n">Params</span><span class="p">.</span><span class="n">MaxRoll</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 11) 注意：Yaw 的最终应用应在 AnimBP 层绕 ShoulderPivot（见下一节）
</span></span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="被抛弃的方案">
<a class="header-anchor" href="#%e8%a2%ab%e6%8a%9b%e5%bc%83%e7%9a%84%e6%96%b9%e6%a1%88"></a>
被抛弃的方案
</h2><h3 id="spring-arm">
<a class="header-anchor" href="#spring-arm"></a>
Spring Arm
</h3><blockquote>
<p>几乎不可用，但在大量初学者教程中出现</p>
</blockquote>
<p>勾选Enable Camera Rotation Lag，使用全身延迟旋转<br>
<a href="https://youtu.be/rZUfkXaVvX4">Weapon Sway in UE4- THE CORRECT WAY | Black Ops Zombies in UE4 #6 - YouTube</a><br>
缺点：不可控，无法限制摆动幅度，并不能真正解决问题<br>
Todo: 询问GPT用视频帧分析摄像机抖动要怎么做</p>
<h1 id="weapon-bobbing">
<a class="header-anchor" href="#weapon-bobbing"></a>
weapon bobbing
</h1><h3 id="基本概念">
<a class="header-anchor" href="#%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5"></a>
基本概念：
</h3><p>武器摆动是枪支的无意移动，由呼吸和手部不稳引起。可通过屏住呼吸来消除，但会消耗体力，或趴在地上。作为平衡机制，通过增加使用高伤害武器（所有机枪和瞄准武器）所需的技能来发挥作用。仅在第一人称瞄准时使用</p>
<p>当玩家静止、瞄准时，武器依然有轻微惯性漂移，如手抖、呼吸带动镜头细微振动。可以用 Perlin Noise 或 Lissajous 曲线生成。<br>
ADS idle sway 并不是立即开始，而是在用户瞄准后有一个 <strong>延迟 (delay)</strong>，然后慢慢增强到最大强度 (over ~3 秒)</p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p><p>使命召唤中Idle Sway采用8字型摇晃<br>
<img src="https://i.ytimg.com/vi/ZdnDTJQBNPY/hqdefault_39966.jpg?sqp=-oaymwEnCNACELwBSFryq4qpAxkIARUAAIhCGAHYAQHiAQoIGBACGAY4AUAB%5c&amp;rs=AOn4CLDRDY1oo08zXx2W1MhzhhikUJNRKA" alt=""></p></p>
  </blockquote>

<h4 id="参考内容">
<a class="header-anchor" href="#%e5%8f%82%e8%80%83%e5%86%85%e5%ae%b9"></a>
参考内容
</h4><p><a href="https://www.youtube.com/watch?v=1qz7VmQ9s78">Unity制作的IdleSway效果</a></p>

  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p>
  <blockquote class="alert-blockquote quote">
    <p class="alert-heading">
      Quote
    </p>
    <p><p>到目前为止，我看到 Lissajous 曲线可能是武器晃动的不错选择，结合基于鼠标移动强度的阻尼效果。但我也看到有些人使用 Perlin 噪声来处理这个问题&hellip;为什么会这样？如何用 Perlin 获得良好的曲线？<br>
我还注意到一些老式射击游戏，如 Quake，只是通过插值生成一个 8 字形状。</p></p>
  </blockquote>


  <blockquote class="alert-blockquote quote">
    <p class="alert-heading">
      Quote
    </p>
    <p><p>在我的游戏中实现武器晃动（我没有动画）时，我使用了两个曲线。它们基本上看起来像一条横向的 S 形（我不擅长数学）。其中一个曲线的持续时间比另一个稍短，并且是倒置的，所以晃动会有一些变化。较短的曲线与时间轴关联，基本上控制垂直变换，而较长的曲线则控制水平方向。考虑到我的射击逻辑直接来自枪管的正前方，这增加了很多变化性，而幸运的是也提供了一些可预测性。我还需要提到的是，这是在 Unreal Blueprints 中实现的，所以我不知道在其他引擎中是否存在类似的功能。</p></p>
  </blockquote></p>
  </blockquote>


  <blockquote class="alert-blockquote example">
    <p class="alert-heading">
      Example
    </p>
    <p></p>
  </blockquote>

<p><a href="https://www.youtube.com/watch?v=gWX-LriRL-c">Dayz的idle sway</a><br>
<a href="https://youtube.com/shorts/5jKKFe5g0tI?si=FmZtNGytnfeIAKDH">战地6冬季攻势和普通动画区别</a></p>
<h1 id="shoot-sway">
<a class="header-anchor" href="#shoot-sway"></a>
Shoot Sway
</h1><p><a href="https://www.youtube.com/watch?v=SWf9pNdivpo%5c&amp;t=8s">How I Made My FPS Game Feel Better To Play</a><br>
视频中一开始采用随机晃动让人眩晕，后来采用purlin noise获得平滑的摄像机抖动<img src="https://cdn.jsdelivr.net/gh/cnwenzhihong/ImageHosting/ProjectMarkdown/PixPin_2025-11-28_11-02-18.gif" alt=""></p>
<p><a href="https://www.bilibili.com/video/BV1dRffYjEra">自制COD20 优化开火动画</a></p>
<h1 id="移动摇晃">
<a class="header-anchor" href="#%e7%a7%bb%e5%8a%a8%e6%91%87%e6%99%83"></a>
移动摇晃
</h1><p><a href="https://www.youtube.com/watch?v=lwM-SbDKnxQ">Realistic Headbob Camera Shakes</a></p>
<h1 id="idle">
<a class="header-anchor" href="#idle"></a>
Idle
</h1></div>
    <footer class="article-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/WzhGameDevPublish/tags/3c"
        rel="tag"
        >3C</a
      >
    </li><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/WzhGameDevPublish/tags/fps"
        rel="tag"
        >FPS</a
      >
    </li><li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/WzhGameDevPublish/tags/blog"
        rel="tag"
        >BLOG</a
      >
    </li></ul>
</footer>
  </div><nav
    id="article-nav"
    aria-label="Article navigation"
    data-aos="fade-up"
  ><div class="article-nav-link-wrap right"><img
              data-src="https://d-sketon.top/img/_backwebp/bg1.webp"
              data-sizes="auto"
              alt="搭建Hugo个人博客"
              class="lazyload"
            /><a
          href="/WzhGameDevPublish/post/%E7%94%B5%E8%84%91/%E7%9F%A5%E8%AF%86%E7%AE%A1%E7%90%86/%E6%90%AD%E5%BB%BAhugo%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"
          aria-label="后一篇:搭建Hugo个人博客"
          title="后一篇:搭建Hugo个人博客"
        ></a>
        <div class="article-nav-caption">后一篇</div>
        <h3 class="article-nav-title">搭建Hugo个人博客</h3>
      </div></nav></article></section>
        </div><footer id="footer" aria-label="Site footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info"><div>
      <span class="icon-copyright"></span>2025<span class="footer-info-sep rotate"></span>
      温志洪
    </div><div>
        基于&nbsp;<a
          href="https://gohugo.io/"
          target="_blank"
          rel="noopener nofollow noreferrer"
          >Hugo</a
        >&nbsp; Theme.<a
          href="https://github.com/D-Sketon/hugo-theme-reimu"
          target="_blank"
          rel="noopener nofollow noreferrer"
          >Reimu</a
        >
      </div><div>
        <span class="icon-brush"
          >&nbsp;9.6k</span
        >
        &nbsp;|&nbsp;
        <span class="icon-coffee">&nbsp;00:20</span>
      </div><div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv"
          >总访问量&nbsp;<span
            id="busuanzi_value_site_pv"
          ></span
        ></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv"
          >总访客量&nbsp;<span
            id="busuanzi_value_site_uv"
          ></span
        ></span>
      </div></div>
</footer>
<div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div><div id="mask" class="hide"></div>
      </div><nav id="mobile-nav" aria-label="Mobile navigation">
  <div class="sidebar-wrap"><div class="sidebar-toc-sidebar"><h3 class="toc-title">文章目录</h3>
<div class="sidebar-toc-wrapper toc-div-class">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#代码实现">代码实现</a>
      <ul>
        <li><a href="#一处理输入量">一、处理输入量</a></li>
        <li><a href="#二计算偏移量">二、计算偏移量</a></li>
        <li><a href="#三应用参数">三、应用参数</a></li>
      </ul>
    </li>
    <li><a href="#参数配置">参数配置</a>
      <ul>
        <li><a href="#优秀的实现案例">优秀的实现案例</a></li>
        <li><a href="#常见游戏方案">常见游戏方案</a></li>
        <li><a href="#工程化">工程化</a></li>
        <li><a href="#旋转ik_gun的yawpitch">旋转IK_Gun的Yaw/Pitch</a></li>
        <li><a href="#额外效果">额外效果</a></li>
      </ul>
    </li>
    <li><a href="#终极方案">终极方案</a>
      <ul>
        <li><a href="#代码">代码</a></li>
        <li><a href="#步骤">步骤</a></li>
      </ul>
    </li>
    <li><a href="#未处理的资料">未处理的资料</a>
      <ul>
        <li><a href="#gpt建议">GPT建议</a></li>
      </ul>
    </li>
    <li><a href="#被抛弃的方案">被抛弃的方案</a>
      <ul>
        <li><a href="#spring-arm">Spring Arm</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#基本概念">基本概念：</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div></div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img
    data-src="/WzhGameDevPublish/avatar/UELogo.png"
    data-sizes="auto"
    alt="温志洪"
    class="lazyload"
  />
  <div class="sidebar-author-name">温志洪</div>
  <div class="sidebar-description">FPS游戏</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>文章</div><div class="sidebar-state-number">2</div>
  </div>
  <a class="sidebar-state-category" href="/WzhGameDevPublish/categories/" aria-label="sidebar-state-category-link">
    <div>分类</div>
    <div class="sidebar-state-number">
      0
    </div>
  </a>
  <a class="sidebar-state-tag" href="/WzhGameDevPublish/tags/" aria-label="sidebar-state-tag-link">
    <div>标签</div>
    <div class="sidebar-state-number">3</div>
  </a>
</div>
<div class="sidebar-social"></div>
<div class="sidebar-menu"><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/WzhGameDevPublish/"
        aria-label="首页"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">首页</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/WzhGameDevPublish/archives"
        aria-label="归档"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">归档</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/WzhGameDevPublish/about"
        aria-label="关于"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">关于</div>
    </div><div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/WzhGameDevPublish/friend"
        aria-label="友链"
      ></a>
      <div class='sidebar-menu-icon icon rotate'>&#xe62b;</div>
      <div class="sidebar-menu-link">友链</div>
    </div></div>
</div></div><div class="sidebar-btn-wrapper">
        <div class="sidebar-toc-btn current"></div>
        <div class="sidebar-common-btn"></div>
      </div></nav>
</div><script
    src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js"
    integrity="sha384-3gT/vsepWkfz/ff7PpWNUeMzeWoH3cDhm/A8jM7ouoAK0/fP/9bcHHR5kHq2nf&#43;e" crossorigin="anonymous"></script><script
    src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js"
    integrity="sha384-J08i8An/QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script><script
    src="https://npm.webcache.cn/material-theme@1.0.0/dist/material-theme.umd.js"
    integrity="sha384-vLev0II0HKFaxkcm&#43;/7kX5IGwVFBASkGchU311wmU/veIj2bB0UcBkQbW6yw2asK" crossorigin="anonymous"></script><script src="/WzhGameDevPublish/js/main.js" ></script><script src="/WzhGameDevPublish/js/aos.js" ></script><script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", aosInit);
    } else {
      aosInit();
    }
  </script><script src="/WzhGameDevPublish/js/pjax_main.js" data-pjax></script><script
    src="https://npm.webcache.cn/mouse-firework@0.1.1/dist/index.umd.js"
    integrity="sha384-8LyaidD9GPxQQgLJO/WRw/O2h3BoNq/ApI/ecpvM6RsrCz2qP2ppBXUKihP4V/2d" crossorigin="anonymous"></script><script>
  if (! false  || !window.matchMedia('(max-width: 768px)').matches) {
    if (window.firework) {
      const options = JSON.parse("{\"excludeelements\":[\"a\",\"button\"],\"particles\":[{\"colors\":[\"var(--red-1)\",\"var(--red-2)\",\"var(--red-3)\",\"var(--red-4)\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"emit\"],\"number\":20,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.3,0.5],\"radius\":[16,32]}},{\"colors\":[\"var(--red-0)\"],\"duration\":[1200,1800],\"easing\":\"easeOutExpo\",\"move\":[\"diffuse\"],\"number\":1,\"shape\":\"circle\",\"shapeOptions\":{\"alpha\":[0.2,0.5],\"lineWidth\":6,\"radius\":20}}]}");
      options.excludeElements = options.excludeelements;
      delete options.excludeelements;
      window.firework(options);
    }
  }
</script><script
    src="https://npm.webcache.cn/quicklink@3.0.1/dist/quicklink.umd.js"
    integrity="sha384-caMDqvgav/HWdEYQU1QRRHMLleigpL1YHAG0m371DhzfL8rRzUyOb&#43;bEHtwlmYjD" crossorigin="anonymous"></script><script data-pjax>
    window.quicklink?.listen({
      timeout:  3000 ,
      priority:  true ,
      ignores: JSON.parse("[]")
    });
  </script>


<div id="lazy-script">
  <div><script data-pjax>
        window.REIMU_POST = {
          author: "温志洪",
          title: "FPS中的武器摇晃",
          url: "http:\/\/localhost:6260\/WzhGameDevPublish\/post\/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91\/%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6\/lyra\/fps\/%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82\/fps%E4%B8%AD%E7%9A%84%E6%AD%A6%E5%99%A8%E6%91%87%E6%99%83\/",
          description: "\r旋转摇晃Weapon Sway\r代码实现\r我们可以将其分为：获取转动输入→计算偏移量→表现三个步骤\n先获取用户转动差值，做各种处理后，用于表现效果\n一、处理输入量\r计算转动量\/输入量的速度，用于后续处理\n",
          cover: "http:\/\/localhost:6260\/WzhGameDevPublish\/images\/banner.webp",
        };
      </script><script src="/WzhGameDevPublish/js/insert_highlight.js" data-pjax></script><script src="/WzhGameDevPublish/js/tabs.js" data-pjax></script><script type="module" data-pjax>const PhotoSwipeLightbox = (await safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe-lightbox.esm.min.js", "sha384-DiL6M\/gG\u002bwmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF\/N6lrZi\/")).default;const initPswp = (gallery, children) => {
          if (_$$(`${gallery} ${children}`).length > 0) {
            new PhotoSwipeLightbox({
              gallery,
              children,pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")}).init();
          }
        }
        const pswp = () => {
          initPswp('.article-entry', 'a.article-gallery-item');
          initPswp('.article-gallery', 'a.article-gallery-item');
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script></div>
</div><script
    src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js"
    asyncintegrity="sha384-0M75wtSkhjIInv4coYlaJU83&#43;OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id&#43;S" crossorigin="anonymous"></script><script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        for (let registration of registrations) {
          registration.unregister();
        }
      });
    }
  </script><script>
  const reimuCopyright = String.raw`
   ______     ______     __     __    __     __  __    
  /\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
  \ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
   \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
    \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                    
  `;
  console.log(String.raw`%c ${reimuCopyright}`, "color: #ff5252;");
  console.log(
    "%c Theme.Reimu" + " %c https://github.com/D-Sketon/hugo-theme-reimu ",
    "color: white; background: #ff5252; padding:5px 0;",
    "padding:4px;border:1px solid #ff5252;",
  );
</script></body>
</html>
